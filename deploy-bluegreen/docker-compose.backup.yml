services:
  # ============================================
  # PostgreSQL Backup (pg_dump)
  # 使い方:
  #   docker compose -f docker-compose.infra.yml -f docker-compose.backup.yml run --rm pgbackup
  # ============================================
  pgbackup:
    image: postgres:18-alpine
    container_name: pecus-pgbackup
    restart: "no"
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_USER: ${POSTGRES_USER:-pecus}
      POSTGRES_DB: ${POSTGRES_DB:-pecusdb}
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      BACKUP_KEEP_DAYS: ${BACKUP_KEEP_DAYS:-14}
    volumes:
      - ${DATA_PATH:?DATA_PATH is required}/backups/postgres:/backups
    command:
      - sh
      - -lc
      - |
        set -eu
        ts="$$(date -u +%Y%m%dT%H%M%SZ)"
        out="/backups/$${POSTGRES_DB}_$${ts}.dump"
        echo "[info] dumping to: $${out}"
        pg_dump -h "$${POSTGRES_HOST}" -p "$${POSTGRES_PORT}" -U "$${POSTGRES_USER}" -d "$${POSTGRES_DB}" -F c -Z 6 -f "$${out}"
        echo "[info] dump done"
        echo "[info] pruning backups older than $${BACKUP_KEEP_DAYS} days"
        find /backups -type f -name "$${POSTGRES_DB}_*.dump" -mtime "+$${BACKUP_KEEP_DAYS}" -print -delete || true
        echo "[ok] backup finished"
    networks:
      - pecus-network

networks:
  pecus-network:
    external: true
    name: pecus-network

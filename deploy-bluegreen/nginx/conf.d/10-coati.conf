# Coati - nginx reverse proxy configuration (blue/green)

upstream coati_blue { server frontend-blue:3000; }
upstream coati_green { server frontend-green:3000; }

upstream coati_api_blue { server pecusapi-blue:7265; }
upstream coati_api_green { server pecusapi-green:7265; }

include /etc/nginx/conf.d/00-active-slot.conf;

map $coati_active_slot $coati_frontend_upstream {
  default http://coati_blue;
  blue    http://coati_blue;
  green   http://coati_green;
}

map $coati_active_slot $coati_api_upstream {
  default http://coati_api_blue;
  blue    http://coati_api_blue;
  green   http://coati_api_green;
}

map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

server {
  listen 80;
  server_name _;

  client_max_body_size 50m;

  proxy_http_version 1.1;
  proxy_set_header Host $http_host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-Host $http_host;
  proxy_set_header X-Forwarded-Server $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # SignalR Hub via /backend/hubs/ (WebSocket support)
  location /backend/hubs/ {
    rewrite ^/backend/hubs/(.*)$ /hubs/$1 break;
    proxy_pass $coati_api_upstream;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_read_timeout 86400s;
  }

  # .NET WebAPI - すべて /backend/ プレフィックス
  location /backend/ {
    rewrite ^/backend/(.*)$ /$1 break;
    proxy_pass $coati_api_upstream;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_read_timeout 86400s;
  }

  # Next.js API Routes - すべて /api/ プレフィックス
  location /api/ {
    proxy_pass $coati_frontend_upstream;
  }

  # Frontend (Next.js)
  location / {
    proxy_pass $coati_frontend_upstream;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
  }
}

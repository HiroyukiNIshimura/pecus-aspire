# Coati - nginx reverse proxy configuration (blue/green)

# NOTE:
# docker compose の内部DNSは、対象コンテナが起動していないと名前解決できません。
# Nginx を infra として単独起動できるよう、upstream での事前解決は避け、
# resolver + 変数 proxy_pass により「リクエスト時に解決」させます。

# Docker embedded DNS
resolver 127.0.0.11 valid=10s ipv6=off;

include /etc/nginx/conf.d/00-active-slot.conf;

map $coati_active_slot $coati_frontend_upstream {
  default frontend-blue:3000;
  blue    frontend-blue:3000;
  green   frontend-green:3000;
}

map $coati_active_slot $coati_api_upstream {
  default pecusapi-blue:7265;
  blue    pecusapi-blue:7265;
  green   pecusapi-green:7265;
}

map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

server {
  listen 80;
  server_name _;

  client_max_body_size 50m;

  proxy_http_version 1.1;
  proxy_set_header Host $http_host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-Host $http_host;
  proxy_set_header X-Forwarded-Server $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # SignalR Hub via /backend/hubs/ (WebSocket support)
  location /backend/hubs/ {
    rewrite ^/backend/hubs/(.*)$ /hubs/$1 break;
    proxy_pass http://$coati_api_upstream;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_read_timeout 86400s;
  }

  # .NET WebAPI - すべて /backend/ プレフィックス
  location /backend/ {
    rewrite ^/backend/(.*)$ /$1 break;
    proxy_pass http://$coati_api_upstream;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_read_timeout 86400s;
  }

  # Next.js API Routes - すべて /api/ プレフィックス
  location /api/ {
    proxy_pass http://$coati_frontend_upstream;
  }

  # Frontend (Next.js)
  location / {
    proxy_pass http://$coati_frontend_upstream;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
  }
}

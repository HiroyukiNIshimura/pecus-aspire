services:
  # ============================================
  # Web API (blue)
  # ============================================
  pecusapi-blue:
    build:
      context: ..
      dockerfile: deploy/dockerfiles/WebApi.Dockerfile
    image: coati-webapi-blue:local
    container_name: pecus-webapi-blue
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: "http://+:7265"
      ASPNETCORE_HTTP_PORTS: "7265"
      ConnectionStrings__pecusdb: "Host=${POSTGRES_HOST:-postgres};Port=5432;Database=${POSTGRES_DB:-pecusdb};Username=${POSTGRES_USER:-pecus};Password=${POSTGRES_PASSWORD}"
      ConnectionStrings__redis: "${REDIS_HOST:-redis}:6379"
      LexicalConverter__Endpoint: ${LEXICAL_CONVERTER_URL:-http://lexicalconverter:5100}
      Frontend__Endpoint: ${FRONTEND_URL:-https://localhost:3000}
      Pecus__FileUpload__StoragePath: /app/data/uploads
    volumes:
      - ${DATA_PATH:?DATA_PATH is required}/uploads:/app/data/uploads
      - ${DATA_PATH:?DATA_PATH is required}/logs/webapi-blue:/app/logs
    # depends_on は ops スクリプトで制御（infra compose と分離するため）
    networks:
      - pecus-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7265/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Frontend (blue)
  # ============================================
  frontend-blue:
    build:
      context: ..
      dockerfile: deploy/dockerfiles/Frontend.Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    image: coati-frontend-blue:local
    container_name: pecus-frontend-blue
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PECUS_API_URL: http://pecusapi-blue:7265
      REDIS_URL: ${REDIS_URL:-redis://redis-frontend:6379}
    # depends_on は ops スクリプトで制御（infra compose と分離するため）
    networks:
      - pecus-network

  # ============================================
  # BackFire (blue) - 2重起動しないこと
  # ============================================
  backfire-blue:
    build:
      context: ..
      dockerfile: deploy/dockerfiles/BackFire.Dockerfile
    image: coati-backfire-blue:local
    container_name: pecus-backfire-blue
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__pecusdb: "Host=${POSTGRES_HOST:-postgres};Port=5432;Database=${POSTGRES_DB:-pecusdb};Username=${POSTGRES_USER:-pecus};Password=${POSTGRES_PASSWORD}"
      ConnectionStrings__redis: "${REDIS_HOST:-redis}:6379"
      LexicalConverter__Endpoint: ${LEXICAL_CONVERTER_URL:-http://lexicalconverter:5100}
      Frontend__Endpoint: ${FRONTEND_URL:-https://localhost:3000}
      UploadsCleanup__UploadsBasePath: /app/data/uploads
      MaintenanceNotification__NotificationsPath: /app/data/notifications
    volumes:
      - ${DATA_PATH:?DATA_PATH is required}/uploads:/app/data/uploads
      - ${DATA_PATH:?DATA_PATH is required}/notifications:/app/data/notifications
      - ${DATA_PATH:?DATA_PATH is required}/logs/backfire-blue:/app/logs
    # depends_on は ops スクリプトで制御（infra compose と分離するため）
    networks:
      - pecus-network

networks:
  pecus-network:
    external: true
    name: pecus-network

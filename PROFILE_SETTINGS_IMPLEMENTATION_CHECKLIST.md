# ユーザープロフィール設定ページ実装確認事項

## 1. API エンドポイント分析（OpenAPI スキーマ確認済み）

### 1.1 既存API仕様

| エンドポイント | メソッド | 入力型 | 出力型 | 説明 |
|---|---|---|---|---|
| `/api/profile` | GET | - | UserResponse | ユーザー情報取得 |
| `/api/profile` | PUT | UpdateProfileRequest | UserResponse | ユーザー情報更新（409: Conflict 対応） |
| `/api/profile/skills` | PUT | SetOwnSkillsRequest | SuccessResponse | スキル設定（洗い替え、409対応） |
| `/api/profile/email` | PATCH | UpdateEmailRequest | MessageResponse | メールアドレス変更 |
| `/api/profile/password` | PATCH | UpdatePasswordRequest | MessageResponse | パスワード変更 |
| `/api/files` | POST | FormData | FileUploadResponse | ファイルアップロード |
| `/api/downloads/{fileType}/{resourceId}/{fileName}` | GET | - | Image(Blob) | ファイルダウンロード |
| `/api/master/skills` | GET | - | MasterSkillResponse[] | スキルマスタ取得 |

### 1.2 型定義（OpenAPI スキーマから確認）

#### AvatarType（3種類）
```typescript
type AvatarType = 'Gravatar' | 'UserAvatar' | 'AutoGenerated';
```

#### FileType（2種類）
```typescript
type FileType = 'Avatar' | 'Genre';
```
- プロフィールアップロードでは **'Avatar'** を使用

#### UpdateProfileRequest（PUT /api/profile）
```typescript
{
  username?: string;              // オプション（最大50文字）
  avatarType?: AvatarType;        // オプション
  avatarUrl?: string | null;      // オプション（最大200文字、URI形式）
  skillIds?: number[];            // オプション（スキルの洗い替え）
  rowVersion: string;             // 必須（楽観的ロック用・byte形式、Base64送受信）
}
```

#### UpdateEmailRequest（PATCH /api/profile/email）
```typescript
{
  newEmail: string;               // 必須（最大100文字、メール形式）
}
```
**重要**: rowVersion なし（行バージョン管理なし）

#### UpdatePasswordRequest（PATCH /api/profile/password）
```typescript
{
  currentPassword: string;        // 必須（最小8文字、最大100文字）
  newPassword: string;            // 必須（最小8文字、最大100文字）
                                  // パターン: ^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,}$
                                  // → 大文字・小文字・数字を含む必須
}
```

#### SetOwnSkillsRequest（PUT /api/profile/skills）
```typescript
{
  skillIds?: number[] | null;      // オプション（空配列ですべて削除）
  userRowVersion?: string | null;  // オプション（楽観的ロック用・byte形式）
}
```

#### UserResponse（GET /api/profile, PUT /api/profile）
```typescript
{
  id: number;                      // 必須
  loginId: string;                 // 必須
  username: string;                // 必須
  email: string;                   // 必須
  avatarType?: AvatarType;         // オプション
  identityIconUrl?: string | null; // オプション（読み取り専用）
  roles: UserRoleResponse[];       // 必須
  skills?: UserSkillResponse[];    // オプション
  isAdmin: boolean;                // 必須
  isActive: boolean;               // 必須
  createdAt: string;               // 日時形式
  rowVersion: string;              // 必須（byte形式、Base64送受信）
}
```

#### MasterSkillResponse（GET /api/master/skills）
```typescript
{
  id: number;                      // 必須
  name: string;                    // 必須
  description?: string | null;     // オプション
}
```

## 2. 機能別実装課題と検討事項

### 2.1 メールアドレスの変更

#### API側（確認済み）
- エンドポイント: `PATCH /api/profile/email`
- リクエスト: `UpdateEmailRequest { newEmail: string }`
  - 必須、最大100文字、メール形式検証
- レスポンス: `MessageResponse { message: string }`
- ステータス: 成功時 200、失敗時 400/404

#### 実装上の注意事項
- ✅ **OpenAPI仕様確認済み**: メールアドレスは最大100文字、メール形式検証必須
- ✅ **rowVersion は不要**: PATCH エンドポイントには rowVersion フィールドなし
- ⚠️ **セキュリティ設計**:
  - 現在のパスワード確認なし（この設計で OK？）
  - WebAPI 側で既存メール重複チェック実装済みと想定
  - メール確認トークンフロー（実装状況不明 → 実装中に確認）

#### フロントエンド検証スキーマ
```typescript
export const emailSchema = z
  .string()
  .email("有効なメールアドレスを入力してください。")
  .max(100, "メールアドレスは100文字以内で入力してください。");
```---

---

### 2.2 スキルの変更

#### API側（確認済み）
- エンドポイント: `PUT /api/profile/skills`
- リクエスト: `SetOwnSkillsRequest`
  - `skillIds?: number[] | null` - 空配列/null ですべて削除
  - `userRowVersion?: string | null` - optional（楽観的ロック用）
- レスポンス: `SuccessResponse { ... }`
- ステータス: 成功時 200、競合時 409、エラー時 400/404

#### 実装上の注意事項
- ✅ **マスタスキルデータ取得**: `GET /api/master/skills` で取得
  - 組織に属するアクティブなスキル一覧を返す
  - SSR 時に初期データとして取得

- ⚠️ **userRowVersion の扱い**:
  - optional フィールド（送信しても、しなくても OK）
  - 競合検出したい場合は `UserResponse.rowVersion` を送信

- ✅ **UI考慮事項**:
  - スキル選択：複数選択（チェックボックス or タグ入力）
  - 既存スキルの表示方法：タグやリスト
  - スキル削除の UX：×ボタンまたはチェック外し

- ✅ **競合処理**:
  - 409 応答時に最新ユーザーデータが返ってくる
  - `UserResponseConcurrencyErrorResponse` で対応

#### フロントエンド検証スキーマ
```typescript
export const skillIdsSchema = z
  .array(z.number().int().positive())
  .optional()
  .nullable();
```

---

### 2.3 パスワードの変更

#### API側（確認済み）
- エンドポイント: `PATCH /api/profile/password`
- リクエスト: `UpdatePasswordRequest`
  - `currentPassword: string` - 必須、最小8文字、最大100文字
  - `newPassword: string` - 必須、最小8文字、最大100文字
  - **パターン**: `^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,}$`
    - → 大文字・小文字・数字を必ず含む必須
- レスポンス: `MessageResponse { message: string }`
- ステータス: 成功時 200、エラー時 400/404

#### 実装上の注意事項
- ✅ **パスワード要件が確定している**:
  - 最小8文字、最大100文字
  - 大文字・小文字・数字を必須に含む
  - 特殊文字 `@$!%*?&` は任意

- ⚠️ **フロントエンド検証**:
  - WebAPI の要件に合わせた Zod スキーマが必須
  - パスワード強度表示（オプション）

- ❓ **セッション管理**:
  - パスワード変更後のトークン再生成必要か？
  - 実装中に確認（トークン有効期限内は有効のまま？）

#### フロントエンド検証スキーマ
```typescript
export const passwordSchema = z
  .string()
  .min(8, "パスワードは8文字以上で入力してください。")
  .max(100, "パスワードは100文字以内で入力してください。")
  .regex(/[a-z]/, "小文字を含める必要があります。")
  .regex(/[A-Z]/, "大文字を含める必要があります。")
  .regex(/\d/, "数字を含める必要があります。");

export const confirmPasswordSchema = passwordSchema;

export const updatePasswordSchema = z.object({
  currentPassword: z.string().min(1, "現在のパスワードは必須です。"),
  newPassword: passwordSchema,
  confirmPassword: confirmPasswordSchema,
}).refine((data) => data.newPassword === data.confirmPassword, {
  message: "新しいパスワードが一致しません。",
  path: ["confirmPassword"],
}).refine((data) => data.currentPassword !== data.newPassword, {
  message: "新しいパスワードは現在のパスワードと異なる必要があります。",
  path: ["newPassword"],
});
```---

### 2.4 アイデンティティアイコンタイプの変更

#### API側（確認済み）
- **UserResponse に含まれるフィールド**: `identityIconUrl?: string | null`
- **UpdateProfileRequest には含まれないフィールド**
- **説明**: アイデンティティアイコンは読み取り専用のようにみえる

#### 実装上の注意事項
- ❓ **仕様が不明確**:
  - ユーザーが変更可能か、自動生成のみか？
  - 変更する場合は PUT /api/profile に `identityIconType` フィールド追加が必要

- **実装方針**:
  - 初版は「読み取り専用」として表示のみ
  - 変更機能が必要な場合は WebAPI 側で仕様確認後に実装

#### 現時点の扱い
- `UserResponse.identityIconUrl` を表示するのみ
- 編集機能は実装しない（仕様確認まで）

---

### 2.5 アバター（ファイルアップロード）

#### API側（確認済み）
- ファイルアップロード: `POST /api/files`
  - FormData: `{ FileType: 'Avatar', ResourceId: number, File: Blob }`
  - 応答: `FileUploadResponse`

- ファイルダウンロード: `GET /api/downloads/{fileType}/{resourceId}/{fileName}`
  - パス: `/api/downloads/Avatar/{userId}/{fileName}`
  - 応答: Image (Blob)

#### FileUploadResponse（確認済み）
```typescript
{
  success?: boolean;           // アップロード成功フラグ
  fileUrl?: string;            // ⭐ アップロード後の公開URL
  fileSize?: number;           // ファイルサイズ（バイト）
  contentType?: string;        // ファイル形式（例: image/jpeg）
  uploadedAt?: string;         // アップロード日時
  message?: string;            // メッセージ
}
```

#### 実装上の注意事項
- ✅ **ファイルアップロードフロー**:
  1. ユーザーがファイル選択
  2. `POST /api/files` でアップロード → `fileUrl` を取得
  3. `PUT /api/profile` で `avatarUrl: fileUrl`, `avatarType: 'UserAvatar'` を送信
  4. プロフィール更新時に rowVersion で競合チェック

- ⚠️ **fileUrl の形式**:
  - 相対 URL か絶対 URL か？（実装時に確認）
  - 即座に GET で取得可能か確認

- ✅ **ファイル表示方法**:
  - `GET /api/downloads/Avatar/{userId}/{fileName}` で取得
  - または `fileUrl` を直接 `<img>` に設定

- **ファイル検証**（フロントエンド）:
  - 許可する画像形式: jpeg, png, webp, gif
  - ファイルサイズ制限: 5MB（WebAPI側の上限確認）
  - ファイルタイプ（MIME）チェック

- **UI 検討**:
  - ファイル入力フィールド
  - アップロード中の進捗表示（オプション）
  - アップロード失敗時のエラーメッセージ
  - プレビュー表示（アップロード前・後）

- ⚠️ **段階的な実装**:
  - 別々のステップか一括更新か設計が必要
  - 推奨: アップロード → URL 取得 → プロフィール更新（2ステップ）---

## 3. 楽観的ロック（rowVersion）の扱い

### 3.1 rowVersion の取得
- GET `/api/profile` で初回取得した `UserResponse.rowVersion`
- **形式**: byte（Base64文字列として JSON 送受信される）

### 3.2 rowVersion を含む更新
- `UpdateProfileRequest` は `rowVersion: string` が必須
  - プロフィール更新（ユーザー名、アバター）時に検証
- `SetOwnSkillsRequest` は `userRowVersion?: string | null` が optional
  - スキル設定時に rowVersion チェックするか選択可能
- 競合検出：`DbUpdateConcurrencyException` → HTTP 409
- Server Action で `detectConcurrencyError()` を使用

### 3.3 各 PATCH エンドポイントでの rowVersion
- **メール変更** (`PATCH /api/profile/email`): rowVersion **不要**
- **パスワード変更** (`PATCH /api/profile/password`): rowVersion **不要**
  - これらは行バージョン管理なしで実装（セキュリティ優先？）

### 3.4 競合時の処理
- 409 応答: `UserResponseConcurrencyErrorResponse` で最新データ返却
- フロントエンド: `detectConcurrencyError()` で判定 → 最新データを再表示---

## 4. Server Action 設計

### 4.1 必要な Server Action（src/actions/profile.ts に実装）

| 関数名 | 入力型 | 出力型 | API 呼び出し | 備考 |
|---|---|---|---|---|
| `updateUserProfile()` | UpdateProfileRequest | ApiResponse<UserResponse> | PUT /api/profile | 競合対応（409） |
| `updateUserEmail()` | UpdateEmailRequest | ApiResponse<MessageResponse> | PATCH /api/profile/email | rowVersion なし |
| `updateUserPassword()` | UpdatePasswordRequest | ApiResponse<MessageResponse> | PATCH /api/profile/password | rowVersion なし |
| `setUserSkills()` | SetOwnSkillsRequest | ApiResponse<SuccessResponse> | PUT /api/profile/skills | optional rowVersion |

### 4.2 エラーハンドリング
- 409 Conflict → `ConflictResponse<T>` で最新データを返す（プロフィール更新）
- 400 Bad Request → `ErrorResponse` でエラーメッセージを返す
- 500 Internal Server Error → `ErrorResponse` で汎用メッセージを返す
- Zod バリデーションエラー → `ErrorResponse` で整理

### 4.3 実装パターン（既存の profile.ts を参考に拡張）
```typescript
export async function updateUserEmail(
  request: UpdateEmailRequest
): Promise<ApiResponse<MessageResponse>> {
  try {
    const api = createPecusApiClients();
    const response = await api.profile.patchApiProfileEmail(request);
    return { success: true, data: response };
  } catch (error: any) {
    // エラーハンドリング...
  }
}
```

---

## 5. ページ構成（Next.js）

### 5.1 ファイル構造
```
src/app/(dashbord)/profile/
  ├── page.tsx              # Server Component（SSR）
  └── ProfileClient.tsx     # Client Component（"use client"）
```

### 5.2 page.tsx の責務（SSR）
- `export const dynamic = 'force-dynamic'` 必須
- Server Actions 呼び出し:
  - `getCurrentUser()` → 現在ユーザー情報 + rowVersion
  - `getMasterSkills()` (master.ts) → マスタスキルデータ
- エラーハンドリング → 401/404 時は redirect
- Props 経由で ProfileClient へデータ渡す

### 5.3 ProfileClient.tsx の責務（クライアント）
- `"use client"` ディレクティブ必須
- フォーム入力値管理（useState）
  - ユーザー名、メール、パスワード、スキルID 等
- Server Action 呼び出し
- UI レンダリング
- バリデーション（Zod + useValidation / useFormValidation）
- ローディング状態管理
- エラー表示
- 成功メッセージ表示

### 5.4 タブ構成（推奨）
- **基本情報タブ**: ユーザー名、メールアドレス、アバター
- **スキルタブ**: スキル選択
- **セキュリティタブ**: パスワード変更
- **その他**: アイデンティティアイコン（読み取り専用表示）

---

## 7. フォーム検証スキーマ（src/schemas/profileSchemas.ts）

### 7.1 基本スキーマ

```typescript
import { z } from "zod";

// ユーザー名（最大50文字）
export const usernameSchema = z
  .string()
  .min(1, "ユーザー名は必須です。")
  .max(50, "ユーザー名は50文字以内で入力してください。");

// メールアドレス（OpenAPI より最大100文字）
export const newEmailSchema = z
  .string()
  .email("有効なメールアドレスを入力してください。")
  .max(100, "メールアドレスは100文字以内で入力してください。");

// 現在のパスワード
export const currentPasswordSchema = z
  .string()
  .min(1, "現在のパスワードは必須です。");

// 新しいパスワード（WebAPI要件: 大小文字・数字必須）
export const newPasswordSchema = z
  .string()
  .min(8, "パスワードは8文字以上で入力してください。")
  .max(100, "パスワードは100文字以内で入力してください。")
  .regex(/[a-z]/, "小文字を含める必要があります。")
  .regex(/[A-Z]/, "大文字を含める必要があります。")
  .regex(/\d/, "数字を含める必要があります。");

// 確認用パスワード
export const confirmPasswordSchema = newPasswordSchema;

// アバター種別
export const avatarTypeSchema = z.enum(["Gravatar", "UserAvatar", "AutoGenerated"]);

// スキル ID リスト
export const skillIdsSchema = z
  .array(z.number().int().positive())
  .optional()
  .nullable();
```

### 7.2 フォーム別スキーマ

```typescript
// メール変更フォーム
export const updateEmailFormSchema = z.object({
  newEmail: newEmailSchema,
});
export type UpdateEmailFormInput = z.infer<typeof updateEmailFormSchema>;

// パスワード変更フォーム
export const updatePasswordFormSchema = z.object({
  currentPassword: currentPasswordSchema,
  newPassword: newPasswordSchema,
  confirmPassword: confirmPasswordSchema,
})
  .refine((data) => data.newPassword === data.confirmPassword, {
    message: "新しいパスワードが一致しません。",
    path: ["confirmPassword"],
  })
  .refine((data) => data.currentPassword !== data.newPassword, {
    message: "新しいパスワードは現在のパスワードと異なる必要があります。",
    path: ["newPassword"],
  });
export type UpdatePasswordFormInput = z.infer<typeof updatePasswordFormSchema>;

// プロフィール更新フォーム（ユーザー名、アバター）
export const updateProfileFormSchema = z.object({
  username: usernameSchema.optional(),
  avatarType: avatarTypeSchema.optional(),
});
export type UpdateProfileFormInput = z.infer<typeof updateProfileFormSchema>;

// スキル設定フォーム
export const updateSkillsFormSchema = z.object({
  skillIds: skillIdsSchema,
});
export type UpdateSkillsFormInput = z.infer<typeof updateSkillsFormSchema>;
```

---

## 8. UI/UX 検討事項

### 8.1 タブ構成（推奨）
- **基本情報タブ**: ユーザー名、メールアドレス、アバター
- **スキルタブ**: スキル選択
- **セキュリティタブ**: パスワード変更
- **その他**: アイデンティティアイコン（読み取り専用表示）

### 8.2 各セクションの UI パターン

#### ユーザー名変更
- テキスト入力
- リアルタイムバリデーション
- 保存ボタン

#### メールアドレス変更
- テキスト入力（type="email"）
- リアルタイムバリデーション
- セキュリティ警告（重要な変更）

#### アバター設定
1. **アバタータイプの選択**
   - ラジオボタン：Gravatar / UserAvatar / AutoGenerated

2. **UserAvatar 選択時**
   - ファイルアップロード入力
   - ファイルプレビュー
   - アップロード進捗表示
   - アップロード後の即座表示更新

#### スキル設定
- **複数選択インターフェース**
  - マスタスキルをチェックボックスリスト表示
  - または multiselect ドロップダウン
  - 選択済みスキルをタグで表示

- **初期値**
  - `UserResponse.skills` から初期チェック状態を設定

#### パスワード変更
- 現在のパスワード入力（必須）
- 新パスワード入力
- 確認用パスワード入力
- パスワード強度インジケーター（オプション）
- 表示・非表示切り替えボタン

---

## 9. 競合処理と再試行 UX

### 9.1 409 Conflict 発生時
- エラーメッセージ表示：「別のユーザーが変更しました。」
- 最新データの自動再取得
- フォーム再ポピュレーション
- ユーザー確認後に再度編集可能にする

### 9.2 rowVersion 更新
- 各更新時に返された `rowVersion` を保持
- 次の更新時にそれを使用

---

## 10. 実装順序（推奨）

1. **スキーマ作成** (`src/schemas/profileSchemas.ts`)
2. **Server Actions 実装** (`src/actions/profile.ts` を拡張)
3. **ページ構成**（`src/app/(dashbord)/profile/page.tsx` + `ProfileClient.tsx`）
4. **UI 実装**（タブ / フォーム / バリデーション表示）
5. **ファイルアップロード機能**（複雑なため最後）
6. **テスト・デバッグ**

---

## 11. セキュリティ考慮事項

- ✅ CSRF トークン：Next.js Server Actions で自動処理
- ✅ HTTPS Only Cookie：`iron-session` で自動処理
- ✅ XSS 対策：React JSX で自動エスケープ
- ✅ パスワード確認：現在のパスワード入力必須
- ❓ メール変更確認：確認メール送信フロー（WebAPI仕様確認必要）
- ❓ Rate Limiting：WebAPI 側で実装確認

---

## 12. 実装時の確認項目（遭遇時に逐一対応）

| 項目 | 確認内容 | 状態 |
|---|---|---|
| メール変更後の確認フロー | 確認メール送信されるか | ❓ |
| ファイルアップロード fileUrl | 絶対 URL か相対 URL か | ❓ |
| fileUrl 即座取得可能性 | アップロード直後に GET 可能か | ❓ |
| パスワード変更後の セッション | トークン再生成必要か | ❓ |
| SetOwnSkillsRequest rowVersion | 送信すべきか | ❓ 仕様上は optional |
| avatarUrl 形式 | fileUrl をそのまま使用 OK か | ❓ |

---
```
- **基本情報**: ユーザー名、メールアドレス、アバター
- **スキル**: スキル選択
- **セキュリティ**: パスワード変更
- **その他**: アイデンティティアイコンタイプ（仕様確認後）

### 7.2 各セクションの UI パターン

#### ユーザー名変更
- テキスト入力
- リアルタイムバリデーション
- 保存ボタン

#### メールアドレス変更
- テキスト入力（type="email"）
- リアルタイムバリデーション
- セキュリティ警告（重要な変更）

#### アバター設定
1. **アバタータイプの選択**
   - ラジオボタン：Gravatar / UserAvatar / AutoGenerated

2. **UserAvatar 選択時**
   - ファイルアップロード入力
   - ファイルプレビュー
   - アップロード進捗表示
   - アップロード後の即座表示更新

#### スキル設定
- **複数選択インターフェース**
  - マスタスキルをチェックボックスリスト表示
  - または multiselect ドロップダウン
  - 選択済みスキルをタグで表示

- **初期値**
  - `UserResponse.skills` から初期チェック状態を設定

#### パスワード変更
- 現在のパスワード入力（必須）
- 新パスワード入力
- 確認用パスワード入力
- パスワード強度インジケーター（オプション）
- 表示・非表示切り替えボタン

---

## 9. 競合処理と再試行 UX

### 9.1 409 Conflict 発生時
- エラーメッセージ表示：「別のユーザーが変更しました。」
- 最新データの自動再取得
- フォーム再ポピュレーション
- ユーザー確認後に再度編集可能にする

### 9.2 rowVersion 更新
- 各更新時に返された `rowVersion` を保持
- 次の更新時にそれを使用

---

## 10. 実装順序（推奨）

1. **スキーマ作成** (`src/schemas/profileSchemas.ts`)
2. **Server Actions 実装** (`src/actions/profile.ts` を拡張)
3. **ページ構成**（`src/app/(dashbord)/profile/page.tsx` + `ProfileClient.tsx`）
4. **UI 実装**（タブ / フォーム / バリデーション表示）
5. **ファイルアップロード機能**（複雑なため最後）
6. **テスト・デバッグ**

---

## 11. セキュリティ考慮事項

- ✅ CSRF トークン：Next.js Server Actions で自動処理
- ✅ HTTPS Only Cookie：`iron-session` で自動処理
- ✅ XSS 対策：React JSX で自動エスケープ
- ✅ パスワード確認：現在のパスワード入力必須
- ❓ メール変更確認：確認メール送信フロー（WebAPI仕様確認必要）
- ❓ Rate Limiting：WebAPI 側で実装確認

---

## 12. 実装時の確認項目（遭遇時に逐一対応）

| 項目 | 確認内容 | 状態 |
|---|---|---|
| メール変更後の確認フロー | 確認メール送信されるか | ❓ |
| ファイルアップロード fileUrl | 絶対 URL か相対 URL か | ❓ |
| fileUrl 即座取得可能性 | アップロード直後に GET 可能か | ❓ |
| パスワード変更後の セッション | トークン再生成必要か | ❓ |
| SetOwnSkillsRequest rowVersion | 送信すべきか | ❓ 仕様上は optional |
| avatarUrl 形式 | fileUrl をそのまま使用 OK か | ❓ |

---

# ダッシュボード統計機能 設計書

## 概要

組織内のタスク状況・チーム活動を可視化するダッシュボード統計機能の設計。
Activity テーブルと WorkspaceItem テーブルを主なデータソースとして、組織レベルの統計情報を提供する。

## 設計理念

アクティビティ要件定義の理念を継承:

```
❌ 従来の管理思想
「誰が何時間働いたか」「何回操作したか」を監視

✅ このアプリの考え方
「タスクが進んだか」「成果物が出たか」だけが重要
```

統計は**監視ツールではなく、チームの健康状態を把握するためのもの**。

---

## スコープの柔軟性

すべての統計は**同じデータソース・同じロジック**で、フィルタ条件を変えるだけで以下のスコープに対応可能:

| スコープ | フィルタ条件 | ユースケース |
|---------|-------------|-------------|
| **組織** | `WorkspaceId IN (組織内WS)` | 管理者が全体を把握 |
| **ワークスペース** | `WorkspaceId = @wsId` | プロジェクト単位の状況確認 |
| **個人** | `AssigneeId = @userId` (タスク系) / `UserId = @userId` (アクティビティ系) | 自分の振り返り |

### 個人スコープへのブレイクダウン

| 組織統計 | 個人統計へのフィルタ |
|---------|---------------------|
| 進行中タスク数 | `AssigneeId = 自分` |
| 完了タスク数 | Activity `UserId = 自分 && ArchivedChanged` |
| 期限切れタスク数 | `AssigneeId = 自分 && DueDate < now` |
| 優先度別タスク数 | `AssigneeId = 自分` でグループ |
| 週次作成/完了推移 | Activity `UserId = 自分` |
| アクション別件数 | Activity `UserId = 自分` |

個人統計は設計理念の「本人が振り返るため」に合致。他人のデータは API レベルで閲覧不可とする。

---

## データソース

| エンティティ | 主要フィールド | 用途 |
|-------------|--------------|------|
| **Activity** | `WorkspaceId`, `ItemId`, `UserId`, `ActionType`, `Details`(jsonb), `CreatedAt` | アクティビティベースの統計 |
| **WorkspaceItem** | `WorkspaceId`, `Priority`, `DueDate`, `IsArchived`, `IsDraft`, `AssigneeId`, `CommitterId`, `CreatedAt`, `UpdatedAt` | タスクベースの統計 |
| **WorkspaceUser** | `WorkspaceId`, `UserId`, `WorkspaceRole`, `JoinedAt`, `LastAccessedAt` | ユーザー参加状況 |
| **User** | `OrganizationId`, `IsActive`, `LastLoginAt` | 組織メンバー情報 |

---

## 統計カテゴリ

### 1. タスクサマリ（WorkspaceItem ベース）

リアルタイムでタスクの現在状態を集計。

| 統計項目 | 説明 | クエリ条件 |
|---------|------|-----------|
| **進行中タスク数** | 公開済み・未アーカイブ | `!IsDraft && !IsArchived` |
| **下書きタスク数** | 下書き状態 | `IsDraft` |
| **完了タスク数** | アーカイブ済み | `IsArchived` |
| **期限切れタスク数** | 期限超過の未完了タスク | `DueDate < now && !IsArchived` |
| **今週期限タスク数** | 今週中に期限 | `DueDate BETWEEN now AND endOfWeek && !IsArchived` |
| **未アサインタスク数** | 担当者未設定の公開タスク | `AssigneeId IS NULL && !IsDraft && !IsArchived` |

#### 優先度別タスク数

| 優先度 | 説明 |
|-------|------|
| Low | 低優先度 |
| Medium | 通常 |
| High | 高優先度 |
| Critical | 緊急 |

```sql
-- 例: 優先度別タスク数
SELECT Priority, COUNT(*)
FROM WorkspaceItems
WHERE WorkspaceId IN (組織内ワークスペース)
  AND NOT IsDraft AND NOT IsArchived
GROUP BY Priority
```

---

### 2. アクティビティ統計（Activity ベース）

過去のアクションを集計してトレンドを可視化。

| 統計項目 | 説明 | 計算方法 |
|---------|------|---------|
| **タスク作成数** | 期間内に作成されたタスク | `ActionType = Created` |
| **タスク完了数** | 期間内にアーカイブされたタスク | `ActionType = ArchivedChanged && Details.new = true` |
| **アクション別件数** | 各アクションタイプの発生回数 | `GROUP BY ActionType` |
| **日別アクティビティ推移** | 日単位の活動量 | `GROUP BY DATE(CreatedAt)` |
| **時間帯別アクティビティ** | 活発な時間帯（ヒートマップ用） | `GROUP BY HOUR(CreatedAt)` |
| **曜日別アクティビティ** | 曜日ごとの傾向 | `GROUP BY DAYOFWEEK(CreatedAt)` |

#### ActionType 別の意味

| ActionType | 統計的意味 |
|------------|-----------|
| `Created` | タスク発生量 |
| `ArchivedChanged` (new=true) | タスク消化量 |
| `SubjectUpdated` / `BodyUpdated` | タスク詳細化の活動 |
| `AssigneeChanged` | アサイン調整頻度 |
| `PriorityChanged` | 優先度見直し頻度 |
| `FileAdded` / `FileRemoved` | 成果物添付活動 |
| `RelationAdded` / `RelationRemoved` | タスク関連付け活動 |

---

### 3. ユーザー・チーム統計

| 統計項目 | 説明 | 計算方法 |
|---------|------|---------|
| **担当者別タスク数** | 各ユーザーの保有タスク | `GROUP BY AssigneeId` |
| **担当者別完了数** | 各ユーザーが完了したタスク | Activity `ArchivedChanged` を `UserId` で集計 |
| **タスク消化率** | 完了 / (保有 + 完了) | 上記2つの比率 |
| **貢献度** | アクティビティ数 | `COUNT(*) GROUP BY UserId` |
| **平均タスク保有数** | ユーザー平均 | 担当タスク総数 / アクティブユーザー数 |

**注意**: 貢献度は「操作回数」であり、「働いた時間」や「成果の質」ではない。
ランキング表示は推奨しない（監視目的と誤解される可能性）。

---

### 4. 期間比較・トレンド

| 統計項目 | 説明 | 期間例 |
|---------|------|-------|
| **今週 vs 先週** | タスク作成/完了数の比較 | 週次 |
| **今月 vs 先月** | アクティビティ数の比較 | 月次 |
| **週次推移グラフ** | 過去N週間の推移 | 4〜12週 |
| **月次推移グラフ** | 過去N ヶ月の推移 | 6〜12ヶ月 |

#### 計算可能な派生指標

| 指標 | 計算式 | 意味 |
|-----|-------|------|
| **タスク消化率** | 完了数 / 作成数 | 1.0 以上なら消化が追いついている |
| **タスク滞留傾向** | 進行中タスク数の週次変化 | 増加傾向 = 滞留リスク |
| **期限遵守率** | 期限内完了 / 完了総数 | 期限管理の健全性 |

---

### 5. ワークスペース別統計

| 統計項目 | 説明 |
|---------|------|
| **ワークスペース別タスク数** | 各ワークスペースのタスク状況 |
| **ワークスペース別アクティビティ** | 活発なワークスペース |
| **ワークスペース別メンバー数** | チーム規模 |

---

## 現在のデータモデルで取れない統計

| 統計項目 | 理由 | 対応案 |
|---------|------|-------|
| **ステータス別タスク数** | WorkspaceItem に `Status` カラムがない | Activity の `StatusChanged` から最新ステータスを逆算するか、WorkspaceItem に Status を追加 |
| **作業時間** | 開始/終了時刻を記録していない | 設計理念により対象外 |
| **コメント数** | コメント機能が Activity に含まれていない | 必要なら `CommentAdded` ActionType を追加 |
| **タスク完了までの平均時間** | 作成日〜アーカイブ日の差分で計算可能だが、Activity からは直接取れない | WorkspaceItem の CreatedAt と Activity の ArchivedChanged を JOIN |

---

## ダッシュボード UI 案

### 組織ダッシュボード

```
┌─────────────────────────────────────────────────────────────────┐
│  📊 組織サマリ                                     [今週] [今月] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │ 進行中   │ │ 完了     │ │ 期限切れ │ │ 未アサイン│           │
│  │   234    │ │   95     │ │   12 ⚠️  │ │    8     │           │
│  │ タスク   │ │ (今週)   │ │          │ │          │           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  📈 タスク推移（週次）                                           │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │     ___                                                   │ │
│  │    /   \    作成 ───                                      │ │
│  │   /     \___/   \                                         │ │
│  │  /              \___   完了 - - -                         │ │
│  │ /                   \                                     │ │
│  └───────────────────────────────────────────────────────────┘ │
│    W1    W2    W3    W4    W5    W6    W7    W8               │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  🎯 優先度別タスク                                              │
│  ┌──────────────────────────────────────────────────┐          │
│  │ Critical ████████ 14                             │          │
│  │ High     ████████████████████████ 50             │          │
│  │ Medium   ████████████████████████████████████ 120│          │
│  │ Low      ████████████████████ 50                 │          │
│  └──────────────────────────────────────────────────┘          │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  👥 ワークスペース別状況                                         │
│  ┌─────────────────┬────────┬────────┬────────┐               │
│  │ ワークスペース   │ 進行中 │ 完了   │ 期限切れ│               │
│  ├─────────────────┼────────┼────────┼────────┤               │
│  │ プロジェクトA    │   45   │   23   │   2    │               │
│  │ プロジェクトB    │   32   │   18   │   0    │               │
│  │ プロジェクトC    │   28   │   12   │   5    │               │
│  └─────────────────┴────────┴────────┴────────┘               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 個人ダッシュボード（自分の振り返り用）

```
┌─────────────────────────────────────────────────────────────────┐
│  👤 マイダッシュボード                              [今週] [今月] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                        │
│  │ 担当中   │ │ 完了     │ │ 期限切れ │                        │
│  │   12     │ │    8     │ │    1 ⚠️  │                        │
│  └──────────┘ └──────────┘ └──────────┘                        │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  📝 今週やったこと                                              │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ • タスク完了: 8件                                         │ │
│  │ • タスク作成: 3件                                         │ │
│  │ • ファイル添付: 5件                                       │ │
│  │ • 件名/本文更新: 12件                                     │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  📅 期限が近いタスク                                            │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ • [PROJ-123] ドキュメント作成        明日 ⚠️               │ │
│  │ • [PROJ-456] レビュー対応            12/15                │ │
│  │ • [PROJ-789] テスト実施              12/18                │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## API エンドポイント案

### 組織統計

```
GET /api/statistics/organizations/{orgId}/summary
  → 組織サマリ（タスク数、期限切れ数など）

GET /api/statistics/organizations/{orgId}/tasks/by-priority
  → 優先度別タスク数

GET /api/statistics/organizations/{orgId}/tasks/trend
  ?period=weekly|monthly
  ?weeks=8
  → タスク作成/完了の推移

GET /api/statistics/organizations/{orgId}/activities/by-type
  ?startDate=2025-12-01&endDate=2025-12-31
  → アクションタイプ別件数

GET /api/statistics/organizations/{orgId}/workspaces
  → ワークスペース別統計
```

### 個人統計

```
GET /api/statistics/users/{userId}/summary
  → 個人サマリ（担当タスク数、完了数など）

GET /api/statistics/users/{userId}/activities
  ?period=weekly|monthly
  → 個人アクティビティサマリ
```

### ワークスペース統計

```
GET /api/statistics/workspaces/{workspaceId}/summary
  → ワークスペースサマリ

GET /api/statistics/workspaces/{workspaceId}/members
  → メンバー別タスク状況
```

---

## パフォーマンス考慮

### キャッシュ戦略

| 統計種別 | キャッシュ TTL | 理由 |
|---------|--------------|------|
| タスクサマリ | 1分 | リアルタイム性が必要 |
| 週次/月次トレンド | 1時間 | 過去データは変わらない |
| 優先度別・ワークスペース別 | 5分 | 頻繁には変わらない |

### インデックス追加案

現在の Activity インデックスに加え、統計クエリ用:

```sql
-- 組織単位での集計用（Workspace経由でOrganizationに紐づく）
CREATE INDEX IX_Activities_WorkspaceId_ActionType_CreatedAt
ON Activities (WorkspaceId, ActionType, CreatedAt);

-- 完了タスク集計用（ArchivedChanged の new=true を高速に取得）
-- ※ Details が jsonb なので GIN インデックスも検討
CREATE INDEX IX_Activities_Details ON Activities USING GIN (Details);
```

### マテリアライズドビュー案

リアルタイム性が不要な統計は定期更新のマテリアライズドビューで対応:

```sql
-- 日次統計サマリ（毎日深夜に更新）
CREATE MATERIALIZED VIEW daily_statistics AS
SELECT
    DATE(CreatedAt) as date,
    WorkspaceId,
    ActionType,
    COUNT(*) as count
FROM Activities
GROUP BY DATE(CreatedAt), WorkspaceId, ActionType;
```

---

## 実装優先度案

### Phase 1: MVP（必須）

1. 組織サマリ（進行中/完了/期限切れタスク数）
2. 個人サマリ（担当タスク数、今週の完了数）
3. 優先度別タスク数

### Phase 2: トレンド可視化

1. 週次タスク作成/完了推移グラフ
2. ワークスペース別統計
3. 期間比較（今週 vs 先週）

### Phase 3: 詳細分析

1. アクションタイプ別統計
2. 時間帯/曜日別ヒートマップ
3. タスク完了までの平均時間

---

## 未決事項

- [ ] ステータス管理の方針決定（WorkspaceItem に Status カラムを追加するか）
- [ ] キャッシュ実装方式（Redis / In-Memory / マテリアライズドビュー）
- [ ] 統計 API の認可ルール（組織管理者のみ / 全メンバー閲覧可）
- [ ] グラフ表示ライブラリの選定（フロントエンド）
- [ ] 統計データのエクスポート機能の要否

---

## 関連ドキュメント

- [アクティビティ要件定義](activity-requirements.md) - データソースの詳細
- [タスクフォーカス推奨機能](task-focus-recommendation.md) - 同じデータを使った「次にやるべきタスク」推奨機能

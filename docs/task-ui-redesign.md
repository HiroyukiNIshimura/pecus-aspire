# タスクUI再設計 提案書

## 概要

現在のタスク関連UIに対するフィードバックを受け、ユーザー体験を向上させるための再設計案をまとめる。

**更新日**: 2025-12-15

---

## 現状の課題と要望

| # | カテゴリ | 課題・要望 | 深刻度 |
|---|---------|-----------|--------|
| 1 | タスクリスト | UIが気に入らない（カードグリッド4x2） | 高 |
| 2 | タスクフロー | モーダル表示ではなく専用画面が望ましい | 中 |
| 3 | タスク識別 | タスクに番号がない（アイテム番号＋連番が欲しい） | 高 |
| 4 | 編集画面 | コミッタ用と担当者用で分離すべき | 高 |
| 5 | 担当者向け | ダイアログではなく専用ページが欲しい | 高 |
| 6 | 視点の違い | コミッタ＝全タスク管理、担当者＝自分のタスク | 高 |

---

## 現在の実装

### タスクリスト（WorkspaceTasks.tsx）
- **表示形式**: カードグリッド（4列 × 2行 = 8件/ページ）
- **ページネーション**: 左右矢印 + ドットインジケーター
- **フィルター**: ステータス（Active/Completed/Discarded/All）、担当者
- **アクション**: カードクリック → EditWorkspaceTaskModal（モーダル）

### タスクフロー（TaskFlowMapModal.tsx）
- **表示形式**: モーダル内に依存関係マップ表示
- **機能**: クリティカルパス、依存チェーン、独立タスクのグループ表示

### タスク編集（EditWorkspaceTaskModal/）
- **表示形式**: モーダル
- **機能**: 前後ナビゲーション、全フィールド編集、コメント

### タスク番号
- **現状**: 存在しない（アイテムには `ItemNumber` / `Code` あり）

### ダッシュボード（/dashboard/tasks, /dashboard/committer）
- マイタスク、コミッター向けページは存在するが、タスク編集はモーダル

---

## 提案: タスク番号の導入

### 1. データモデル変更

**WorkspaceTask エンティティに追加**:

```csharp
/// <summary>
/// アイテム内で一意の連番
/// </summary>
public int TaskNumber { get; set; }

/// <summary>
/// 表示用タスクコード（例: "WS001-001-01"）
/// ワークスペースコード + アイテム番号 + タスク連番
/// </summary>
public string TaskCode { get; set; } = string.Empty;
```

### 2. タスクコードの形式

```
{WorkspaceCode}-{ItemNumber:000}-{TaskNumber:00}

例:
- PROJ-001-01  （PROJワークスペース、アイテム1、タスク1）
- MANUAL-023-03 （MANUALワークスペース、アイテム23、タスク3）
```

### 3. 採番ロジック

- **TaskNumber**: アイテム作成時に `MAX(TaskNumber) + 1` で採番
- **TaskCode**: `TaskNumber` 確定後に自動生成
- 欠番は許容（削除時に再利用しない）

### 4. UI表示

- タスクカード、一覧、編集画面すべてで `TaskCode` を目立つように表示
- 検索・フィルターで `TaskCode` を使用可能に

---

## 提案: タスクUI再構成

### 全体構成

```
┌─────────────────────────────────────────────────────────────────────┐
│                        コミッタ向けUI                                │
│  (/workspaces/[code] 内、または /dashboard/committer)                │
├─────────────────────────────────────────────────────────────────────┤
│  • アイテム単位でタスクを俯瞰                                        │
│  • 全タスクの一覧表示（テーブル形式、ページネーション）                  │
│  • 一括操作（担当者変更、優先度変更など）                              │
│  • タスクフローは専用ページ                                          │
│  • 編集はインライン or サイドパネル（モーダルも可）                     │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                        担当者向けUI                                  │
│  (/dashboard/my-tasks 専用ページ)                                    │
├─────────────────────────────────────────────────────────────────────┤
│  • 自分のタスクのみ表示                                              │
│  • ダッシュボードから遷移（専用ページ）                                │
│  • アイテム情報も同時に確認可能                                       │
│  • タスク詳細は専用ページ（モーダルではない）                          │
│  • フォーカス推奨機能と連携                                           │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 詳細設計

### A. タスクリストの再設計

#### 現状の問題
- カードグリッド（4x2）は一覧性が低い
- 情報密度が低く、スクロールが多い
- コールセンター業務画面のような印象

#### 提案: 2つの表示モード

**1. テーブルビュー（コミッタ向けデフォルト）**

| TaskCode | 内容 | 担当者 | 状態 | 優先度 | 期限 | 進捗 | 操作 |
|----------|------|--------|------|--------|------|------|------|
| PROJ-001-01 | APIエンドポイント設計 | 田中 | 進行中 | 高 | 12/20 | 60% | ✏️ 💬 |
| PROJ-001-02 | 単体テスト作成 | 佐藤 | 未着手 | 中 | 12/22 | 0% | ✏️ 💬 |

- ソート可能（コード、期限、優先度、担当者）
- 行クリックで編集パネルを開く
- ページネーション（20件/ページ）
- 一括選択 & 操作

**2. カンバンビュー（オプション）**

```
┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐
│  未着手    │ │  進行中    │ │  レビュー   │ │  完了      │
├────────────┤ ├────────────┤ ├────────────┤ ├────────────┤
│ ┌────────┐ │ │ ┌────────┐ │ │            │ │ ┌────────┐ │
│ │ 001-01 │ │ │ │ 001-02 │ │ │            │ │ │ 001-03 │ │
│ │ 設計   │ │ │ │ 実装   │ │ │            │ │ │ テスト │ │
│ └────────┘ │ │ └────────┘ │ │            │ │ └────────┘ │
│ ┌────────┐ │ │            │ │            │ │            │
│ │ 001-04 │ │ │            │ │            │ │            │
│ └────────┘ │ │            │ │            │ │            │
└────────────┘ └────────────┘ └────────────┘ └────────────┘
```

- ドラッグ&ドロップでステータス変更
- タスクタイプ別カラムも選択可能

**3. 現行カードグリッド（維持、ビュー切替可能）**

- 既存実装を残し、ビュー切替で選択可能に

---

### B. タスク編集画面の分離

#### 1. コミッタ用編集（モーダル/サイドパネル）

**目的**: アイテム内の複数タスクを素早く編集

**特徴**:
- テーブル行クリック → サイドパネル表示（モーダルも選択可）
- 前後ナビゲーションで連続編集
- 全フィールド編集可能
- 先行タスク設定、コメント閲覧

```
┌─────────────────────────────────────────────────────────────────────┐
│  アイテム: API設計書 [PROJ-001]                                      │
├───────────────────────────────────┬─────────────────────────────────┤
│  タスク一覧 (テーブル)             │  編集パネル                      │
│                                   │                                 │
│  [x] PROJ-001-01 設計 田中 12/20  │  TaskCode: PROJ-001-01          │
│  [ ] PROJ-001-02 実装 佐藤 12/22  │  ─────────────────────          │
│  [ ] PROJ-001-03 テスト -  12/25  │  担当者: [田中 ▼]               │
│                                   │  優先度: [高 ▼]                 │
│                                   │  期限: [12/20]                  │
│                                   │  進捗: [====60%====]            │
│                                   │  ...                            │
│                                   │  [保存] [キャンセル]             │
└───────────────────────────────────┴─────────────────────────────────┘
```

#### 2. 担当者用タスク詳細ページ（専用ページ）

**URL**: `/dashboard/tasks/[taskCode]` または `/tasks/[taskCode]`

**目的**: 自分のタスクに集中、アイテム文脈も確認

**特徴**:
- フルページ表示（モーダルではない）
- アイテム情報（件名、本文プレビュー）も表示
- タスク詳細、コメント、添付ファイル
- 完了/進捗更新に特化したUI
- 関連タスク（同アイテム内）の確認

```
┌─────────────────────────────────────────────────────────────────────┐
│  🏠 Dashboard > マイタスク > PROJ-001-01                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  📄 関連アイテム: API設計書 [PROJ-001]                       │    │
│  │  ───────────────────────────────────────────────────────     │    │
│  │  APIエンドポイントの設計ドキュメント。                        │    │
│  │  REST API仕様に従って...                    [アイテムを見る →] │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  📋 タスク詳細                                               │    │
│  │  ───────────────────────────────────────────────────────     │    │
│  │  PROJ-001-01                                                 │    │
│  │                                                               │    │
│  │  **APIエンドポイント設計**                                    │    │
│  │                                                               │    │
│  │  タイプ: 設計        優先度: 🔴 高                            │    │
│  │  期限: 2025/12/20    残り: 5日                               │    │
│  │                                                               │    │
│  │  進捗: [========60%========]                                  │    │
│  │                                                               │    │
│  │  予定工数: 8h   実績工数: 5h                                  │    │
│  │                                                               │    │
│  │  [進捗を更新] [完了にする] [ヘルプを求める]                    │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  💬 コメント (3)                                             │    │
│  │  ...                                                         │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  📎 関連タスク（同アイテム内）                                │    │
│  │  ───────────────────────────────────────────────────────     │    │
│  │  ✅ PROJ-001-00 要件定義 (完了)                               │    │
│  │  🔵 PROJ-001-01 設計 ← 現在                                   │    │
│  │  ⏳ PROJ-001-02 実装 (待機中 - 先行タスク未完了)               │    │
│  │  ⚪ PROJ-001-03 テスト (未着手)                               │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

### C. タスクフロー画面の分離

#### 現状
- モーダル内に依存関係マップ表示
- 画面が狭く、複雑な依存関係の把握が困難

#### 提案: 専用ページ化

**URL**: `/workspaces/[code]/items/[itemCode]/flow`

**特徴**:
- フルスクリーン表示
- ズーム、パン操作
- ノードクリックで詳細サイドパネル
- クリティカルパスのハイライト
- フィルタリング（担当者、ステータス）

```
┌─────────────────────────────────────────────────────────────────────┐
│  🔗 タスクフロー: API設計書 [PROJ-001]                    [閉じる]  │
├─────────────────────────────────────────────────────────────────────┤
│  フィルター: [担当者 ▼] [ステータス ▼]    ズーム: [−] 100% [+]      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│     ┌──────────┐                                                    │
│     │ 001-00   │                                                    │
│     │ 要件定義 │ ✅                                                 │
│     └────┬─────┘                                                    │
│          │                                                          │
│          ▼                                                          │
│     ┌──────────┐      ┌──────────┐                                  │
│     │ 001-01   │ ───▶ │ 001-02   │                                  │
│     │ 設計     │ 🔵   │ 実装     │ ⏳                               │
│     └────┬─────┘      └────┬─────┘                                  │
│          │                 │                                        │
│          └────────┬────────┘                                        │
│                   ▼                                                 │
│              ┌──────────┐                                           │
│              │ 001-03   │                                           │
│              │ テスト   │ ⚪                                        │
│              └──────────┘                                           │
│                                                                     │
│  [クリティカルパス: 001-00 → 001-01 → 001-02 → 001-03]              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

### D. ダッシュボードからの導線

#### 現状
- `/dashboard/tasks` - マイタスク一覧（アコーディオン形式）
- `/dashboard/committer` - コミッター向け一覧

#### 提案: 導線の改善

**1. マイタスク（担当者向け）**

```
/dashboard/tasks
  │
  ├── ワークスペース×期限日 アコーディオン（現行維持）
  │     └── タスク行クリック → /dashboard/tasks/[taskCode] （専用ページへ）
  │
  └── タスクフォーカス推奨カード
        └── 「今やるべき」タスクを1つ表示 → クリックで専用ページへ
```

**2. コミッター向け**

```
/dashboard/committer
  │
  ├── ワークスペース選択
  │     └── アイテム一覧 → アイテムクリック → /workspaces/[code]?item=[itemCode]
  │
  └── 全タスク統計（期限切れ、未アサインなど）
        └── クリックでフィルター適用した一覧へ
```

---

## 実装ロードマップ

### Phase 1: タスク番号の導入（優先度: 最高）

1. **DB変更**
   - `WorkspaceTask` に `TaskNumber`, `TaskCode` カラム追加
   - マイグレーション作成、既存データへの採番

2. **API変更**
   - 作成時の採番ロジック実装
   - レスポンスDTOに `TaskCode` 追加

3. **UI変更**
   - 全タスク表示箇所で `TaskCode` を表示
   - 検索機能に `TaskCode` 対応

### Phase 2: タスクリストの表示モード追加（優先度: 高）

1. **テーブルビュー実装**
   - `WorkspaceTasksTable.tsx` 新規作成
   - ソート、ページネーション実装
   - 一括操作UI

2. **ビュー切替UI**
   - テーブル/カード/カンバン切替ボタン
   - ユーザー設定への保存

### Phase 3: 担当者向け専用ページ（優先度: 高）

1. **ページ作成**
   - `/dashboard/tasks/[taskCode]/page.tsx`
   - `TaskDetailPage.tsx` コンポーネント

2. **導線変更**
   - ダッシュボードからの遷移先を専用ページに

### Phase 4: タスクフロー専用ページ（優先度: 中）

1. **ページ作成**
   - `/workspaces/[code]/items/[itemCode]/flow/page.tsx`
   - フルスクリーン対応のフローマップ

2. **既存モーダルからの移行**
   - モーダル内のリンクで専用ページへ誘導
   - 将来的にモーダル廃止検討

### Phase 5: コミッタ用サイドパネル編集（優先度: 中）

1. **サイドパネル実装**
   - リスト + パネルのレイアウト
   - テーブル行選択でパネル表示

---

## 技術的考慮事項

### タスク番号の採番

```csharp
// WorkspaceTaskService.cs
public async Task<WorkspaceTask> CreateTaskAsync(CreateTaskDto dto)
{
    // アイテム内の最大TaskNumberを取得
    var maxTaskNumber = await _context.WorkspaceTasks
        .Where(t => t.WorkspaceItemId == dto.WorkspaceItemId)
        .MaxAsync(t => (int?)t.TaskNumber) ?? 0;

    var task = new WorkspaceTask
    {
        // ...
        TaskNumber = maxTaskNumber + 1,
        TaskCode = GenerateTaskCode(workspace.Code, item.ItemNumber, maxTaskNumber + 1)
    };

    // ...
}

private string GenerateTaskCode(string wsCode, int itemNumber, int taskNumber)
{
    return $"{wsCode}-{itemNumber:D3}-{taskNumber:D2}";
}
```

### SSR対応

- 担当者向け専用ページはSSRで初期データ取得
- タスクフローページもSSRで依存関係データを事前取得

### 権限制御

- 担当者向けページ: 自分のタスクのみ表示
- コミッタ向け: アイテムのコミッタまたはオーナーのみ全タスク表示

---

## 影響範囲

### 変更が必要なファイル

**バックエンド**:
- `pecus.Libs/DB/Models/WorkspaceTask.cs` - カラム追加
- `pecus.DbManager/Migrations/` - 新規マイグレーション
- `pecus.WebApi/Services/WorkspaceTaskService.cs` - 採番ロジック
- `pecus.WebApi/Models/Responses/` - DTO更新

**フロントエンド**:
- `src/app/(workspace-full)/workspaces/[code]/WorkspaceTasks.tsx` - ビュー切替
- `src/app/(dashbord)/tasks/[taskCode]/page.tsx` - 新規ページ
- `src/app/(workspace-full)/workspaces/[code]/items/[itemCode]/flow/page.tsx` - 新規ページ
- `src/components/tasks/` - 新規コンポーネント群

### 互換性

- 既存APIの破壊的変更なし（`TaskCode` は追加フィールド）
- 既存UIは維持しつつ、新しいビューを追加

---

## まとめ

| 課題 | 解決策 | 優先度 |
|------|--------|--------|
| タスク番号がない | `TaskCode` 導入（WS-001-01形式） | 最高 |
| リストUIが不満 | テーブルビュー追加、ビュー切替 | 高 |
| 担当者用がモーダル | 専用ページ化（ダッシュボードから遷移） | 高 |
| フローがモーダル | 専用ページ化 | 中 |
| コミッタ/担当者の視点混在 | 明確に分離したUI設計 | 高 |

この設計により、コミッタと担当者それぞれの視点に最適化されたUIを提供し、タスク管理の効率を大幅に向上させる。

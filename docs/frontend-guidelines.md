# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

## 1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

`pecus.Frontend` ã¯ Next.jsï¼ˆReactï¼‰+ TypeScript ã«ã‚ˆã‚‹SPA/Web UIæ‹¡å¼µç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚ä¸»ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ–¹é‡ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: Reactï¼ˆNext.jsï¼‰
- **å‹å®‰å…¨**: TypeScript
- **çŠ¶æ…‹ç®¡ç†**: jotai
- **UIãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: Tailwind CSS + FlyonUI
- **APIé€šä¿¡**: OpenAPI/Swaggerå®šç¾©ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸå‹å®‰å…¨ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆ`openapi-typescript-codegen`ï¼‰
- **èªè¨¼**: pecus.WebApiã®JWTèªè¨¼ã¨é€£æºï¼ˆRedis ãƒ™ãƒ¼ã‚¹ã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€Cookie ã«ã¯ sessionId ã®ã¿ä¿å­˜ï¼‰
- **ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**: SPAãƒ«ãƒ¼ã‚¿ãƒ¼ï¼ˆNext.jsã®App Routerï¼‰
- **ãƒ†ã‚¹ãƒˆ**: Jest, React Testing Library, Playwright ãªã©
- **CI/CD**: GitHub Actionsç­‰ã§ã®è‡ªå‹•ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤

APIè¨­è¨ˆã‚„èªè¨¼ãƒ•ãƒ­ãƒ¼ã¯ `pecus.WebApi` å´ã®ä»•æ§˜ã«å³å¯†ã«å¾“ã£ã¦ãã ã•ã„ã€‚ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¿å­˜ãƒ»é€ä¿¡æ–¹æ³•ã‚„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã«åˆã‚ã›ã¦å®Ÿè£…ã—ã¾ã™ã€‚

## 2. APIã‚¢ã‚¯ã‚»ã‚¹ãƒ«ãƒ¼ãƒ«

**åŸºæœ¬æ–¹é‡**: èª­ã¿å–ã‚Šæ“ä½œï¼ˆQueryï¼‰ã¨å¤‰æ›´æ“ä½œï¼ˆMutationï¼‰ã‚’åˆ†é›¢ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ `pecus.WebApi` ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã¯ç¦æ­¢

### è¨±å¯/ç¦æ­¢ãƒãƒˆãƒªã‚¯ã‚¹ï¼ˆè¦ç‚¹ï¼‰
- SSRï¼ˆServer Componentï¼‰: è¨±å¯ï¼ˆ`createPecusApiClients()` çµŒç”±ãƒ»`ServerSessionManager`ã§ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼‰
- Server Actions: è¨±å¯ï¼ˆ`createPecusApiClients()` çµŒç”±ï¼‰ã€‚`fetch('http://webapi...')` ã¯ç¦æ­¢
- Next.js API Routes: è¨±å¯ï¼ˆ`createPecusApiClients()` çµŒç”±ãƒ»ã‚µãƒ¼ãƒãƒ¼å´ã§å®Ÿè¡Œï¼‰
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: ç›´æ¥å‘¼ã³å‡ºã—ç¦æ­¢ï¼ˆServer Actions / API Routes ã‚’çµŒç”±ï¼‰
- ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰WebApiç›´å©ã: ç¦æ­¢ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³éœ²å‡ºé˜²æ­¢ãƒ»ç›£æŸ»æ€§ç¢ºä¿ï¼‰
- Next.js Middleware: sessionId ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã®ã¿ï¼ˆRedis ã‚¢ã‚¯ã‚»ã‚¹ãªã—ã€Edge Runtime å¯¾å¿œï¼‰

### ğŸ“– èª­ã¿å–ã‚Šæ“ä½œï¼ˆãƒ‡ãƒ¼ã‚¿å–å¾—ï¼‰

- **SSRæ™‚ã®åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆæ¨å¥¨ï¼‰**: `page.tsx` ã® Server Component ã§å®Ÿè¡Œ
  - `createPecusApiClients()` ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
  - `pecus.WebApi` ã‹ã‚‰ç›´æ¥ãƒ‡ãƒ¼ã‚¿å–å¾—
  - Props çµŒç”±ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¸å‚ç…§ã‚’æ¸¡ã™
  - ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¸ãƒ£ãƒ³ãƒ«ã€ã‚¹ã‚­ãƒ«ã€ã‚¿ã‚°ï¼‰ã€èªè¨¼æƒ…å ±ã€ãƒšãƒ¼ã‚¸åˆæœŸãƒ‡ãƒ¼ã‚¿

- **å‹•çš„ãªãƒ‡ãƒ¼ã‚¿å†å–å¾—ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼‰**: Next.js API Routes ã§å®Ÿè¡Œ
  - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ `Next.js API Routes` â†’ `pecus.WebApi` ã®æµã‚Œ
  - `src/app/api/admin/workspaces/route.ts` ãªã©
  - API Routeså†…ã§ `createPecusApiClients()` ã‚’ä½¿ç”¨ã—ã¦ `pecus.WebApi` ã«ã‚¢ã‚¯ã‚»ã‚¹
    - ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã® `ServerSessionManager`ï¼ˆ`pecus.Frontend/src/libs/serverSession.ts`ã€Redis ã‹ã‚‰è‡ªå‹•å–å¾—ï¼‰ã‹ã‚‰å–å¾—

### âœï¸ å¤‰æ›´æ“ä½œï¼ˆãƒ‡ãƒ¼ã‚¿å¤‰æ›´ï¼‰

- **Server Actions ã‚’åˆ©ç”¨**: `src/actions/` ã«å®Ÿè£…
  - `"use server"` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§å®£è¨€
  - `createPecusApiClients()` ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
  - POST/PUT/DELETE ãªã©ã®å¤‰æ›´å‡¦ç†ã‚’å®Ÿè¡Œ
  - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ `await serverActionName(data)` ã§å‘¼ã³å‡ºã—
  - ä¾‹ï¼š`await createWorkspace(request)` â†’ Server Action å†…ã§ APIå‘¼ã³å‡ºã—

**Server Actions ã®è¨­è¨ˆæ„å›³ã¨å†…éƒ¨å‹•ä½œ**:
- Server Actions ã¯ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‡ãƒ¼ã‚¿ã®ä½œæˆã€æ›´æ–°ã€å‰Šé™¤ãªã©ï¼‰ã‚’ç°¡ç´ åŒ–ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™
- å†…éƒ¨çš„ã«ã¯ HTTP POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¾ã™
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã¯å‹å®‰å…¨ãªé–¢æ•°å‘¼ã³å‡ºã—ã®ã‚ˆã†ã«ä½¿ç”¨ã§ãã¾ã™ãŒã€å®Ÿéš›ã«ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã™

### âŒ ç¦æ­¢äº‹é …

- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§ç›´æ¥ `pecus.WebApi` ã«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³éœ²å‡ºã®ãƒªã‚¹ã‚¯ï¼‰
- Server Actions/SSR ã‹ã‚‰ `fetch()` ã§ `pecus.WebApi` ã‚’ç›´æ¥å‘¼ã³å‡ºã™ï¼ˆä¾‹ï¼š`fetch('http://webapi:5000/...)`ï¼‰ã€‚ä¾‹å¤–: ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ API ã®ã¿å¾ªç’°å›é¿ã®ãŸã‚ç›´ `fetch` ã‚’è¨±å¯ã€‚
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã® `fetch('/api/admin/workspaces')` ã®å¤šç”¨ï¼ˆåˆæœŸãƒ‡ãƒ¼ã‚¿ã¯SSRå´ã§å–å¾—ï¼‰

### ğŸ”„ ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†

- **OpenAPI ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š**: `createPecusApiClients()` ãŒ OpenAPI ã® `TOKEN` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã« `getAccessToken()` ã‚’è¨­å®šï¼ˆè‡ªå‹•ãƒˆãƒ¼ã‚¯ãƒ³ä»˜ä¸ï¼‰
- **Server Actions/API Routes**: `createPecusApiClients()` ã®å‘¼ã³å‡ºã—ã§è‡ªå‹•çš„ã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ãƒ»ä»˜ä¸ã•ã‚Œã‚‹
- **ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥**: `getAccessToken()` å‘¼ã³å‡ºã—æ™‚ã« `ServerSessionManager.getValidAccessToken()` ãŒæœ‰åŠ¹æœŸé™ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å¿…è¦ã«å¿œã˜ã¦è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’å®Ÿè¡Œ

## 3. API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è‡ªå‹•ç”Ÿæˆ

- **è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«**: `src/connectors/api/PecusApiClient.generated.ts` ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€æ‰‹å‹•ã§ç·¨é›†ã—ãªã„ã“ã¨
- **ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: `scripts/generate-pecus-api-client.js` ãŒ `src/connectors/api/pecus/services/` å†…ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã€`createApiClientInstances()` ãƒ•ã‚¡ã‚¯ãƒˆãƒªé–¢æ•°ã¨ `configureOpenAPI()` è¨­å®šé–¢æ•°ã‚’ç”Ÿæˆ
- **è‡ªå‹•å®Ÿè¡Œ**: `npm run dev` / `npm run build` ã®å®Ÿè¡Œå‰ã«è‡ªå‹•çš„ã«ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹ï¼ˆ`predev` / `prebuild` ãƒ•ãƒƒã‚¯ï¼‰
- **æ‰‹å‹•å®Ÿè¡Œ**: å¿…è¦ã«å¿œã˜ã¦ `npm run generate:client` ã§æ‰‹å‹•å®Ÿè¡Œå¯èƒ½
- **ç”Ÿæˆå†…å®¹**: `createApiClientInstances()` ã¯ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã‚’è¿”ã™ãƒ•ã‚¡ã‚¯ãƒˆãƒªé–¢æ•°ã€‚`createPecusApiClients()` ã¯ã“ã‚Œã‚’å‘¼ã³å‡ºã—ã¦ OpenAPI è¨­å®šã‚’è¡Œã„ã€è¨­å®šæ¸ˆã¿ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ï¼ˆ`src/connectors/api/PecusApiClient.ts` ã§å®šç¾©ï¼‰
- **Gitç®¡ç†**: è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ `.gitignore` ã«ç™»éŒ²æ¸ˆã¿
 - **ç·¨é›†å¯/ä¸å¯ã®SSoT**: ç·¨é›†å¯: `src/connectors/api/PecusApiClient.ts`ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ãƒ»OpenAPI è¨­å®šãƒ­ã‚¸ãƒƒã‚¯ï¼‰ï¼ç·¨é›†ä¸å¯: `src/connectors/api/PecusApiClient.generated.ts`ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å®šç¾©ï¼‰ï¼å‹ã®å‚ç…§: `src/connectors/api/pecus/index.ts`ï¼ˆè‡ªå‹•ç”Ÿæˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰

## 4. ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã®è¨­è¨ˆæ–¹é‡

> è©³ç´°ã¯ `docs/auth-architecture-redesign.md` ã‚’å‚ç…§

### ä¿å­˜å ´æ‰€

| æƒ…å ± | ä¿å­˜å ´æ‰€ | å‚™è€ƒ |
|------|----------|------|
| sessionId | Cookieï¼ˆ`httpOnly: true`, `sameSite: 'strict'`ï¼‰ | ãƒ–ãƒ©ã‚¦ã‚¶ã«æ®‹ã‚‹ã®ã¯ã“ã‚Œã®ã¿ |
| accessToken | Redisï¼ˆNext.js ã‚µãƒ¼ãƒãƒ¼å´ï¼‰ | ãƒ–ãƒ©ã‚¦ã‚¶ã«ã¯é€ä¿¡ã—ãªã„ |
| refreshToken | Redisï¼ˆNext.js ã‚µãƒ¼ãƒãƒ¼å´ï¼‰ | ãƒ–ãƒ©ã‚¦ã‚¶ã«ã¯é€ä¿¡ã—ãªã„ |
| user/device æƒ…å ± | Redisï¼ˆNext.js ã‚µãƒ¼ãƒãƒ¼å´ï¼‰ | ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿æŒ |

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç‰¹æ€§

- **XSS è€æ€§**: ãƒˆãƒ¼ã‚¯ãƒ³ãŒãƒ–ãƒ©ã‚¦ã‚¶ã«å­˜åœ¨ã—ãªã„ãŸã‚ã€XSS ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¾ã‚Œã‚‹ãƒªã‚¹ã‚¯ãŒãªã„
- **ãƒãƒƒãƒˆã‚«ãƒ•ã‚§å¯¾ç­–**: ç«¯æœ«ã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ®‹ã‚‰ãªã„ï¼ˆsessionId ã®ã¿ã€httpOnly ã§ä¿è­·ï¼‰
- **å³æ™‚ç„¡åŠ¹åŒ–**: Redis ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã™ã‚‹ã ã‘ã§å³åº§ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¯èƒ½

### ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ãƒ•ãƒ­ãƒ¼

1. Server Actions / API Routes ã§ `getAccessToken()` ã‚’å‘¼ã³å‡ºã—
2. `ServerSessionManager.getValidAccessToken()` ãŒ Redis ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
3. ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ5åˆ†ã®ãƒãƒƒãƒ•ã‚¡ï¼‰
4. æœŸé™åˆ‡ã‚Œé–“è¿‘ãªã‚‰ `ServerSessionManager.refreshTokens()` ã§è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
5. æœ‰åŠ¹ãªã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿”ã™

### è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥

- **ãƒˆãƒªã‚¬ãƒ¼**: `getAccessToken()` å‘¼ã³å‡ºã—æ™‚ã«æœ‰åŠ¹æœŸé™ãŒ5åˆ†æœªæº€ã®å ´åˆ
- **å‡¦ç†**: `ServerSessionManager.refreshTokens()` ãŒ WebAPI ã® `/api/entrance/refresh` ã‚’å‘¼ã³å‡ºã—
- **æ›´æ–°**: Redis ä¸Šã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆCookie ã® sessionId ã¯å¤‰æ›´ãªã—ï¼‰

### å¤±æ•—æ™‚ã®å‡¦ç†

- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¤±æ•—æ™‚: Redis ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã€Cookie ã‚’ã‚¯ãƒªã‚¢ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™åˆ‡ã‚Œ: Middleware ãŒ sessionId ä¸åœ¨ã‚’æ¤œçŸ¥ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

### Middleware ã®å½¹å‰²

- sessionId Cookie ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã®ã¿ï¼ˆEdge Runtime å¯¾å¿œï¼‰
- Redis ã‚¢ã‚¯ã‚»ã‚¹ã¯è¡Œã‚ãªã„ï¼ˆServer Components / Server Actions ã«å§”è­²ï¼‰
- æ—§å½¢å¼ã® Cookieï¼ˆaccessToken, refreshToken, user, deviceï¼‰ã‚’æ¤œå‡ºã—ãŸå ´åˆã¯å‰Šé™¤ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

- **ã‚¯ãƒ©ã‚¹**: `ServerSessionManager`ï¼ˆ`src/libs/serverSession.ts`ï¼‰
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: Redisï¼ˆã‚­ãƒ¼: `frontend:session:{sessionId}`ï¼‰
- **TTL**: æœ€å¤§30æ—¥ï¼ˆã‚¹ãƒ©ã‚¤ãƒ‡ã‚£ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€éã‚¢ã‚¯ãƒ†ã‚£ãƒ–7æ—¥ã§æœŸé™åˆ‡ã‚Œï¼‰

### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|----------|------|
| `src/libs/serverSession.ts` | `ServerSessionManager` - Redis ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ |
| `src/libs/session.ts` | äº’æ›ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆéæ¨å¥¨ã€ServerSessionManager ã«å§”è­²ï¼‰ |
| `src/connectors/api/auth.ts` | ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ãƒ»ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã® Server Actions |
| `src/middleware.ts` | sessionId å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆEdge Runtime å¯¾å¿œï¼‰ |
| `src/actions/auth.ts` | ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã® Server Actions |
| `src/connectors/api/PecusApiClient.ts` | API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šï¼ˆæ‰‹å‹•ç·¨é›†å¯èƒ½ï¼‰ |
| `src/connectors/api/PecusApiClient.generated.ts` | API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆéƒ¨åˆ†ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰ |

## 5. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å‘½åè¦å‰‡

### Server Component ã¨ Client Component ã®åŒºåˆ¥

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¨®é¡ã‚’æ˜ç¢ºã«ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®å‘½åè¦å‰‡ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ï¼š

| ç¨®é¡ | ãƒ•ã‚¡ã‚¤ãƒ«å | ä¾‹ |
|------|-----------|-----|
| Server Component | `*.server.tsx` | `DashboardSidebar.server.tsx`, `StatCard.server.tsx` |
| Client Component | `*.tsx`ï¼ˆã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã—ï¼‰ | `AppHeader.tsx`, `UserMenu.tsx` |

### Server Component ã®ä¸€è¦§ï¼ˆ`src/components/`ï¼‰

**common/**
- `AppFooter.server.tsx` - ãƒ•ãƒƒã‚¿ãƒ¼
- `DashboardSidebar.server.tsx` - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚µã‚¤ãƒ‰ãƒãƒ¼
- `PasswordRequirementIndicator.server.tsx` - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦ä»¶è¡¨ç¤º

**dashboard/**
- `HelpCommentsCard.server.tsx` - ãƒ˜ãƒ«ãƒ—ã‚³ãƒ¡ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰
- `HotItemsCard.server.tsx` - æ³¨ç›®ã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ¼ãƒ‰
- `HotWorkspacesCard.server.tsx` - æ³¨ç›®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰
- `PriorityBreakdownCard.server.tsx` - å„ªå…ˆåº¦å†…è¨³ã‚«ãƒ¼ãƒ‰
- `StatCard.server.tsx` - çµ±è¨ˆã‚«ãƒ¼ãƒ‰
- `TaskSummarySection.server.tsx` - ã‚¿ã‚¹ã‚¯ã‚µãƒãƒªãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³

### åˆ¤æ–­åŸºæº–

**Server Componentï¼ˆ`*.server.tsx`ï¼‰ã«ã™ã¹ãå ´åˆ**:
- `'use client'` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ãŒãªã„
- ãƒ–ãƒ©ã‚¦ã‚¶ APIï¼ˆ`useState`, `useEffect`, `useRouter` ãªã©ï¼‰ã‚’ä½¿ç”¨ã—ãªã„
- é™çš„ãªUIã€ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã®ã¿
- å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã« Client Component ã‚’å«ã‚“ã§ã‚‚è‰¯ã„

**Client Componentï¼ˆ`*.tsx`ï¼‰ã«ã™ã¹ãå ´åˆ**:
- `'use client'` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ãŒã‚ã‚‹
- React Hooksï¼ˆ`useState`, `useEffect`, `useCallback` ãªã©ï¼‰ã‚’ä½¿ç”¨
- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆ`onClick`, `onChange` ãªã©ï¼‰ã‚’ä½¿ç”¨
- ãƒ–ãƒ©ã‚¦ã‚¶å°‚ç”¨ API ã‚’ä½¿ç”¨

### æ³¨æ„äº‹é …

- `editor/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã¯ Lexical ã‚¨ãƒ‡ã‚£ã‚¿ã®æ§‹é€ ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã€ã“ã®å‘½åè¦å‰‡ã‚’é©ç”¨ã—ã¾ã›ã‚“
- ãƒãƒ¬ãƒ«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆ`index.ts`ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå…ˆã‚‚æ›´æ–°ã—ã¦ãã ã•ã„

## 6. Next.js å®Ÿè£…ã‚¬ã‚¤ãƒ‰

### Next.js å›ºæœ‰ã®æ³¨æ„äº‹é …
- **å‹•çš„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã«å¿œã˜ã¦å¿…è¦ãªå ´åˆã®ã¿ `export const dynamic = 'force-dynamic'` ã‚’è¨­å®šï¼ˆå¸¸æ™‚å¿…é ˆã§ã¯ãªã„ï¼‰
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: try-catch ã§ API ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›
- **ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹**: ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒä¸­ã¯é©åˆ‡ãªãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
- **ç’°å¢ƒå¤‰æ•°**: pecus.WebApiã®ãƒ™ãƒ¼ã‚¹ URL ã¯ `process.env.API_BASE_URL`ã§ç®¡ç†
- **Server Actions**: SSR ã§ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«ã¯ Server Actionsï¼ˆ`src/actions/`ï¼‰ã‚’ä½¿ç”¨
- **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªæ©Ÿèƒ½ã«ã¯ `"use client"` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ä»˜ä¸

### SSRï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

ãƒšãƒ¼ã‚¸æ§‹æˆã¯ä»¥ä¸‹ã®çµ±ä¸€ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã£ã¦ãã ã•ã„ï¼š

**ãƒ‘ã‚¿ãƒ¼ãƒ³: `page.tsx` (SSR) + `XxxClient.tsx` (Client Component)**

```
src/app/(dashboard)/admin/xxxxx/
  â”œâ”€â”€ page.tsx              # Server Component (SSR)
  â””â”€â”€ XxxClient.tsx         # Client Component ("use client")
```

- **`page.tsx` (SSR/Server Component ã®è²¬å‹™)**
  - `export const dynamic = 'force-dynamic'` ã‚’å¿…ãšè¨­å®š
  - Server Actions ã§ `getCurrentUser()` ã‚„ API ãƒ‡ãƒ¼ã‚¿ã‚’ fetch
  - Props çµŒç”±ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¼ è¾¾
  - ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆtry-catchï¼‰
  - èªè¨¼ãƒã‚§ãƒƒã‚¯ãƒ»èªå¯ãƒã‚§ãƒƒã‚¯

- **`XxxClient.tsx` (Client Component ã®è²¬å‹™)**
  - `"use client"` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–å¿…é ˆ
  - UI ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®ã¿
  - ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ç®¡ç†ï¼ˆUI ã®é–‹é–‰ã€ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ã€ãƒšãƒ¼ã‚¸ãƒ³ã‚°ã€ãƒ•ã‚£ãƒ«ã‚¿ãªã©ï¼‰
  - ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  - **é‡è¦**: SSR ã‹ã‚‰ã® Props çµŒç”±ã§ãƒ‡ãƒ¼ã‚¿å—ã‘å–ã‚Šã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã® API å‘¼ã³å‡ºã—ã¯ã—ãªã„

**ç¦æ­¢äº‹é …ï¼ˆã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰**
- âŒ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ `useEffect` ã§ `/api/user` ãªã©ã® API å‘¼ã³å‡ºã—ã‚’ã—ãªã„ã“ã¨
- âŒ ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’ `"use client"` ã§ãƒãƒ¼ã‚¯ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå†…ã§å…¨ API å‘¼ã³å‡ºã—ã‚’ã™ã‚‹ã“ã¨
- âŒ ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¸ãƒ£ãƒ³ãƒ«ã€ã‚¹ã‚­ãƒ«ã€ã‚¿ã‚°ãªã©ï¼‰ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ fetch ã™ã‚‹ã“ã¨
- âŒ åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡æ•°ç®‡æ‰€ã‹ã‚‰ fetch ã™ã‚‹ã“ã¨ï¼ˆSSR ã§ä¸€åº¦ã« fetch ã—ã¦ Props ã§é…åˆ†ï¼‰

**å®Ÿè£…ä¾‹**
```typescript
// page.tsx (SSR)
export const dynamic = 'force-dynamic';
export default async function AdminTagsPage() {
  let user = null;
  let fetchError = null;
  try {
    const result = await getCurrentUser();
    if (result.success) user = result.data;
  } catch (err) {
    fetchError = err.message;
  }
  return <AdminTagsClient initialUser={user} fetchError={fetchError} />;
}

// AdminTagsClient.tsx (Client)
"use client";
export default function AdminTagsClient({ initialUser, fetchError }) {
  const [sidebarOpen, setSidebarOpen] = useState(false);
  // UI state ã®ã¿ç®¡ç†ã€API å‘¼ã³å‡ºã—ãªã—
  return <div>...</div>;
}
```

### ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…
- **å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**: `src/components/common/Pagination.tsx` ã‚’ä½¿ç”¨
- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: `react-paginate` ã‚’ä½¿ç”¨ã—ã€FlyonUI ã‚¹ã‚¿ã‚¤ãƒ«ã§çµ±ä¸€
- **ãƒšãƒ¼ã‚¸ç•ªå·**: ã‚µãƒ¼ãƒãƒ¼å´ã¯ 1-basedã€`react-paginate` ã¯ 0-based ã®ãŸã‚å¤‰æ›ãŒå¿…è¦
- **ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°**: `gap-0.5` ã§ãƒœã‚¿ãƒ³é–“ã«é©åº¦ãªé–“éš”ã‚’è¨­å®š
- **æ¡ä»¶è¡¨ç¤º**: `totalPages <= 1` ã®å ´åˆã¯è‡ªå‹•çš„ã«éè¡¨ç¤º


### HTMLç”Ÿæˆãƒ«ãƒ¼ãƒ«
- **buttonè¦ç´ **: å¿…ãš `type` å±æ€§ã‚’æ­£ã—ãè¨­å®šã™ã‚‹ã“ã¨ï¼ˆä¾‹: `type="button"`, `type="submit"`, `type="reset"`ï¼‰
- **labelè¦ç´ **: å¿…ãš `for` å±æ€§ã‚’æ­£ã—ãè¨­å®šã—ã€å¯¾å¿œã™ã‚‹inputè¦ç´ ã®idã¨ä¸€è‡´ã•ã›ã‚‹ã“ã¨
- **formè¦ç´ **: `onSubmit` ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§ `event.preventDefault()` ã‚’å‘¼ã³å‡ºã™ã‹ã€buttonã« `type="button"` ã‚’è¨­å®šã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€ä¿¡å‹•ä½œã‚’é˜²æ­¢
- **imgè¦ç´ **: å¿…ãš `alt` å±æ€§ã‚’è¨­å®šã—ã¦ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã‚’ç¢ºä¿ï¼ˆè£…é£¾ç”»åƒã®å ´åˆã¯ `alt=""` ã§ç©ºæ–‡å­—ã‚’è¨­å®šï¼‰
- **inputè¦ç´ **:
  - ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã«ã¯é©åˆ‡ãª `type` å±æ€§ã‚’è¨­å®šï¼ˆ`text`, `email`, `password`, `number` ãªã©ï¼‰
  - å¿…é ˆé …ç›®ã«ã¯ `required` å±æ€§ã‚’è¨­å®š
  - ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¯ `placeholder` å±æ€§ã§è¨­å®šã—ã€ãƒ©ãƒ™ãƒ«ã®ä»£æ›¿ã«ã—ãªã„
- **selectè¦ç´ **: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠé …ç›®ã«ã¯ `defaultValue` ã¾ãŸã¯ `value` ã‚’é©åˆ‡ã«è¨­å®š
- **ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£**:
  - ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªè¦ç´ ï¼ˆã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªdivãªã©ï¼‰ã«ã¯é©åˆ‡ãªARIAå±æ€§ï¼ˆ`role`, `aria-label`ï¼‰ã‚’è¨­å®š
  - ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã«å¯¾å¿œï¼ˆ`tabIndex`, `onKeyDown`ï¼‰
- **Next.js Image**: å¤–éƒ¨ç”»åƒã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ `next/image` ã® `Image` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã€`next.config.ts` ã§ `remotePatterns` ã‚’è¨­å®š
- **className**: Tailwind CSS + FlyonUI ã®ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã€ã‚«ã‚¹ã‚¿ãƒ CSSã¯æœ€å°é™ã«æŠ‘ãˆã‚‹

## 7. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆZodï¼‰

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®å…¥åŠ›æ¤œè¨¼ã«ã¯ **Zod** ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚å‹å®‰å…¨ã§å®£è¨€çš„ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

### ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…ã®3å±¤æ§‹é€ 

1. **ã‚¹ã‚­ãƒ¼ãƒå®šç¾©å±¤** (`src/schemas/`)
   - å†åˆ©ç”¨å¯èƒ½ãªZodã‚¹ã‚­ãƒ¼ãƒã‚’ä¸€å…ƒç®¡ç†
   - å…±é€šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«ï¼ˆæ–‡å­—æ•°åˆ¶é™ã€å½¢å¼ãƒã‚§ãƒƒã‚¯ç­‰ï¼‰ã‚’å®šç¾©
   - å‹æ¨è«–ã«ã‚ˆã‚Š TypeScript ã§è‡ªå‹•çš„ã«å‹å®‰å…¨æ€§ã‚’ç¢ºä¿

2. **ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å±¤** (`src/utils/validation.ts`)
   - Zodã‚¹ã‚­ãƒ¼ãƒã‚’ä½¿ã£ãŸæ±ç”¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
   - éåŒæœŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼ˆrefine/transformï¼‰
   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çµ±ä¸€çš„ãªæŠ½å‡º

3. **ãƒ•ãƒƒã‚¯å±¤** - ç”¨é€”ã«ã‚ˆã‚Š2ã¤ã®ãƒ•ãƒƒã‚¯ã‚’ä½¿ã„åˆ†ã‘ã‚‹

   **3-1. å€‹åˆ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ (`src/hooks/useValidation.ts`)**
   - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå…¥åŠ›æ™‚ï¼‰ã«æœ€é©
   - å˜ä¸€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ or ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å˜ä½ã®æ¤œè¨¼ã«ä½¿ç”¨
   - æ¤œç´¢æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã©

   **3-2. ãƒ•ã‚©ãƒ¼ãƒ å…¨ä½“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ (`src/hooks/useFormValidation.ts`)**
   - ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®åŒ…æ‹¬çš„ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å˜ä½ã®ã‚¨ãƒ©ãƒ¼ç®¡ç†ãƒ»è¡¨ç¤º
   - Server Actions ã¸ã®é€£æº
   - è¤‡æ•°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å…¥åŠ›æ™‚æ¤œè¨¼ã¨é€ä¿¡æ™‚æ¤œè¨¼

### ãƒ•ã‚©ãƒ¼ãƒ èªè¨¼ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã«ã¯ **Server Actions ã¨ Zod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ„ã¿åˆã‚ã›ãŸä»¥ä¸‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³** ã‚’æ¡ç”¨ã—ã¦ãã ã•ã„ã€‚

**ã€åŸºæœ¬ãƒ•ãƒ­ãƒ¼ã€‘**
1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ `useValidation` ãƒ•ãƒƒã‚¯ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
2. é€ä¿¡æ™‚ã«ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰æ¤œè¨¼ã‚’å†å®Ÿè¡Œ
3. æ¤œè¨¼æˆåŠŸå¾Œã« API å‘¼ã³å‡ºã—
4. æˆåŠŸæ™‚ã¯ `redirect()` ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã€å¤±æ•—æ™‚ã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™

**ã€å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆã€‘**

1. **ã‚¹ã‚­ãƒ¼ãƒå®šç¾©**: å†åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚­ãƒ¼ãƒã‚’ `src/schemas/` ã«é…ç½®
2. **Server Action**: `src/actions/` ã«ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å‡¦ç†ã‚’é›†ç´„
3. **äºŒé‡æ¤œè¨¼**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¤œè¨¼ï¼ˆUXï¼‰+ ã‚µãƒ¼ãƒãƒ¼æ¤œè¨¼ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: Zod ã‚¨ãƒ©ãƒ¼ã¨ API ã‚¨ãƒ©ãƒ¼ã‚’åŒºåˆ¥ã—ã¦å‡¦ç†
5. **ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹**: é€ä¿¡ä¸­ã¯ãƒœã‚¿ãƒ³ã‚’ disabled ã«ã—ã¦å¤šé‡é€ä¿¡ã‚’é˜²æ­¢
6. **ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ**: æˆåŠŸæ™‚ã¯ Server Action å†…ã§ `redirect()` ã‚’å®Ÿè¡Œ
7. **ãƒ•ã‚©ãƒ¼ãƒ å€¤**:
   - å¿…é ˆé …ç›®ã¯ `required` å±æ€§ã‚’ä»˜ä¸
   - å…¥åŠ›è£œåŠ©ï¼ˆè‡ªå‹•å°æ–‡å­—åŒ–ãªã©ï¼‰ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å®Ÿæ–½
   - é¸æŠç³»è¦ç´ ã¯åˆæœŸå€¤ã‚’æ˜ç¤ºçš„ã«è¨­å®š

**ã€ç¦æ­¢äº‹é …ã€‘**

- âŒ Server Action ã‹ã‚‰ç›´æ¥ `fetch()` ã§ API å‘¼ã³å‡ºã—ï¼ˆä»£ã‚ã‚Šã« `createPecusApiClients()` ã‚’ä½¿ç”¨ï¼‰
- âŒ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§ API ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆServer Action ã§é›†ç´„ï¼‰
- âŒ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãã®ã¾ã¾è¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›ï¼‰
- âŒ è¤‡æ•°ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’è¨±å¯ï¼ˆisLoading ã§é˜²æ­¢ï¼‰

## 8. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°çµ±ä¸€æ–¹é‡

### Server Actions ã¨ WebAPI ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹

Server Action ãŒ Next.js ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã™å…±é€šæˆ»ã‚Šå€¤å‹ã¯ä¸‹è¨˜ `ApiResponse<T>` ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`T` ã¯ WebAPIï¼ˆè‡ªå‹•ç”Ÿæˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰ãŒè¿”ã™ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‹ã§ã™ã€‚

```typescript
export type ApiResponse<T> =
  | { success: true; data: T }
  | ConflictResponse<T>
  | ErrorResponse;
```

- `ConflictResponse<T>`: ä¸¦è¡Œæ›´æ–°ï¼ˆHTTP 409ï¼‰ã‚’è¡¨ã™å‹ã€‚æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ã¦è¿”å´ã™ã‚‹ã“ã¨ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å†å–å¾—ãƒ»ãƒãƒ¼ã‚¸å‡¦ç†ã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã® `detectConcurrencyError` ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’å‚ç…§ï¼‰ã€‚
- `ErrorResponse`: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ã™æ±ç”¨ã‚¨ãƒ©ãƒ¼å‹ã€‚è‡ªå‹•ç”Ÿæˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã® `services/*` ã®è¿”ã‚Šå€¤ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆã‚ã›ã¦ãã ã•ã„ã€‚

å®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ï¼ˆè¦ç‚¹ï¼‰:

1. Server Action ã®æˆ»ã‚Šå‹ã¯å¸¸ã« `Promise<ApiResponse<T>>` ã‚’æ¡ç”¨ã™ã‚‹ï¼ˆ`T` ã¯ `pecus.Frontend/src/connectors/api/pecus/index.ts` ã®å‹ï¼‰ã€‚
2. API å‘¼ã³å‡ºã—ã¯ `createPecusApiClients()` ã‚’ä½¿ã†ï¼ˆç›´æ¥ `fetch()` ã‚’å©ã‹ãªã„ã“ã¨ï¼‰ã€‚
3. ã‚¨ãƒ©ãƒ¼å‡¦ç†:
   - 409ï¼ˆConcurrencyï¼‰ã¯ `detectConcurrencyError(error)` ã‚’ä½¿ã£ã¦ `ConflictResponse<T>` ã‚’è¿”ã™ã€‚
   - ãã®ä»–ã® API ã‚¨ãƒ©ãƒ¼ã¯ `ErrorResponse` ã‚’è¿”ã™ï¼ˆ`error.body?.message` ç­‰ã‚’åˆ©ç”¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ•´å½¢ï¼‰ã€‚
4. æˆåŠŸæ™‚ã¯ `{ success: true, data: response }` ã‚’è¿”ã™ã€‚

### Server Actions ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆ`src/actions/`ï¼‰

Server Actions ã¯çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’è¿”ã—ã¾ã™ã€‚ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¯ `src/actions/types.ts` ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

**ã‚¨ãƒ©ãƒ¼å‹å®šç¾©**:
```typescript
export type ErrorResponse = {
  success: false;
  error: 'validation' | 'server' | 'not_found' | 'forbidden';
  message: string;
};
```

**ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°**:
| é–¢æ•° | ç”¨é€” | ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ— |
|------|------|-------------|
| `validationError<T>(message)` | å…¥åŠ›å€¤ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ | `validation` |
| `serverError<T>(message)` | API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¨ãƒ©ãƒ¼ï¼ˆéä¾‹å¤–ï¼‰ | `server` |
| `notFoundError<T>(message)` | ãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„ | `not_found` |
| `forbiddenError<T>(message)` | æ¨©é™ä¸è¶³ | `forbidden` |
| `parseErrorResponse<T>(error, defaultMessage)` | catch ã§æ•æ‰ã—ãŸä¾‹å¤–ã‚’è§£æ | çŠ¶æ³ã«ã‚ˆã‚‹ |

### API ãƒ«ãƒ¼ã‚¿ãƒ¼ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆ`src/app/api/`ï¼‰

API ãƒ«ãƒ¼ã‚¿ãƒ¼ã¯çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’è¿”ã—ã¾ã™ã€‚ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¯ `src/app/api/routerError.ts` ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

**ã‚¨ãƒ©ãƒ¼å‹å®šç¾©**:
```typescript
export type RouterErrorType = {
  error: string;
  status: number;
};
```

### é€šçŸ¥ã®ä½¿ã„åˆ†ã‘ï¼ˆ`useNotify` ãƒ•ãƒƒã‚¯ï¼‰

`src/hooks/useNotify.ts` ã® `error()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ç¬¬2å¼•æ•°ã§æ°¸ç¶šè¡¨ç¤ºã‚’åˆ¶å¾¡ã§ãã¾ã™ã€‚

**ä½¿ã„åˆ†ã‘ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³**:
| ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ | `persistent` | ç†ç”± |
|-----------|--------------|------|
| é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼ˆfetch å¤±æ•—ï¼‰ | `true` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚‹ |
| ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ | `false` | å…¥åŠ›ã‚’ä¿®æ­£ã™ã‚Œã°è§£æ±ºã™ã‚‹ãŸã‚ã€ã™ãæ¶ˆãˆã¦è‰¯ã„ |
| Server Actions ã®ã‚¨ãƒ©ãƒ¼ | `false` | ä¸€æ™‚çš„ãªã‚¨ãƒ©ãƒ¼ãŒå¤šãã€å†è©¦è¡Œã§è§£æ±ºã™ã‚‹ã“ã¨ãŒå¤šã„ |
| é‡å¤§ãªã‚¨ãƒ©ãƒ¼ï¼ˆãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±ç­‰ï¼‰ | `true` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºå®Ÿã«èªè­˜ã•ã›ãŸã„å ´åˆ |

### æ¡ä»¶ä»˜ããƒ¦ãƒ‹ã‚ªãƒ³å‹ï¼ˆDiscriminated Unionï¼‰ã®æ‰±ã„æ–¹

`ApiResponse<T>` ã®ã‚ˆã†ãªæ¡ä»¶ä»˜ããƒ¦ãƒ‹ã‚ªãƒ³å‹ã‚’æ‰±ã†éš›ã¯ã€**Early Returnï¼ˆã‚¬ãƒ¼ãƒ‰ç¯€ï¼‰ãƒ‘ã‚¿ãƒ¼ãƒ³**ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

**âœ… æ¨å¥¨: Early Return ãƒ‘ã‚¿ãƒ¼ãƒ³**
```typescript
const result = await fetchData();

// ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã‚’å…ˆã«ãƒã‚§ãƒƒã‚¯ã—ã¦æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
if (!result.success) {
  setError(result.message);
  return;
}

// ã“ã“ã§ result.success === true ãŒç¢ºå®šã€result.data ã«å®‰å…¨ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
const data = result.data;
doSomething(data);
```

**âŒ ç¦æ­¢: else if ã§çµ‚ã‚ã‚‹æ§‹æ–‡**
```typescript
// å¯èª­æ€§ãŒä½ãã€å‹ã®ãƒŠãƒ­ãƒ¼ã‚¤ãƒ³ã‚°ã‚‚ä¸è‡ªç„¶
if (result.success) {
  // æ­£å¸¸ç³»
} else if (!result.success) {
  // ã‚¨ãƒ©ãƒ¼ç³»ï¼ˆelse if ã§çµ‚ã‚ã‚‹ã®ã¯é¿ã‘ã‚‹ï¼‰
}
```

**âŒ ç¦æ­¢: å‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³**
```typescript
// å‹å®‰å…¨æ€§ãŒå¤±ã‚ã‚Œã‚‹
const data = (result as SuccessResponse).data;
```

**ç†ç”±**:
- Early Return ã«ã‚ˆã‚Šã€æ­£å¸¸ç³»ã®ã‚³ãƒ¼ãƒ‰ãŒãƒ•ãƒ©ãƒƒãƒˆã«èª­ã‚ã‚‹
- TypeScript ã®å‹ãƒŠãƒ­ãƒ¼ã‚¤ãƒ³ã‚°ãŒè‡ªç„¶ã«æ©Ÿèƒ½ã™ã‚‹
- `else if` ã§çµ‚ã‚ã‚‹æ§‹æ–‡ã¯å¯èª­æ€§ãŒä½ãã€æ„å›³ãŒä¸æ˜ç¢ºã«ãªã‚‹

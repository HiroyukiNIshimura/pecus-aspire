# チャット UI 設計

## 概要

チャット機能のフロントエンド UI 設計ドキュメントです。
スマホ対応を最優先としながら、PC でも快適に使えるレスポンシブ設計を目指します。

---

## 設計方針

### 基本コンセプト

| 項目 | 方針 |
|------|------|
| スマホ対応 | **最優先**。スマホで使いにくいデザインは NG |
| コンポーネント再利用 | 同一コンポーネントをデバイス別に出し分け |
| 遷移方式 | スマホ: フル画面遷移 / PC: ボトムドロワー |

### デバイス別表示方式

| デバイス | 表示方式 | 理由 |
|----------|---------|------|
| スマホ | `/chat` へフル画面遷移 | 画面が狭いため、LINE/iMessage 風が最適 |
| PC | ボトムドロワー（下から出現） | 作業コンテキストを維持しながらチャット可能。入力欄が画面下部で自然 |

---

## コンポーネント構成

### 共通コンポーネント（再利用）

```
src/components/chat/
├── ChatRoomList.tsx          # ルーム一覧（タブ付き）
├── ChatRoomListItem.tsx      # ルーム一覧の1行
├── ChatMessageList.tsx       # メッセージ一覧
├── ChatMessageItem.tsx       # メッセージ1件
├── ChatMessageInput.tsx      # メッセージ入力欄
├── ChatHeader.tsx            # チャットヘッダー（ルーム名、戻るボタン等）
├── ChatTypingIndicator.tsx   # 入力中表示
└── ChatUnreadBadge.tsx       # 未読バッジ
```

### レイアウトコンポーネント（デバイス別）

```
src/components/chat/
├── ChatBottomDrawer.tsx      # PC用: ボトムドロワーコンテナ
├── ChatFullScreen.tsx        # スマホ用: フルスクリーンコンテナ
└── ChatContainer.tsx         # デバイス判定 + 適切なレイアウト選択
```

---

## 画面構成

### ルーム一覧画面

```
┌─────────────────────────────┐
│  [←戻る]  チャット          │  ← ChatHeader
├─────────────────────────────┤
│  [DM] [グループ] [通知]     │  ← タブ切り替え
├─────────────────────────────┤
│  ┌─────────────────────┐    │
│  │ 👤 田中さん    (2)  │    │  ← ChatRoomListItem
│  │    最新: お疲れ様！ │    │
│  └─────────────────────┘    │
│  ┌─────────────────────┐    │
│  │ 👥 開発チーム       │    │
│  │    最新: 了解です   │    │
│  └─────────────────────┘    │
│  ┌─────────────────────┐    │
│  │ 🔔 システム    (1)  │    │
│  │    お知らせがあり.. │    │
│  └─────────────────────┘    │
│                             │
│  [＋ 新規DM]                │  ← DM タブ時のみ表示
└─────────────────────────────┘
```

### メッセージ画面

```
┌─────────────────────────────┐
│  [←戻る]  田中さん     [⋮]  │  ← ChatHeader（設定メニュー付き）
├─────────────────────────────┤
│                             │
│  ┌───────────────────┐      │
│  │ こんにちは！      │      │  ← 相手のメッセージ（左寄せ）
│  │ 10:30            │      │
│  └───────────────────┘      │
│                             │
│          ┌───────────────┐  │
│          │ お疲れ様です！│  │  ← 自分のメッセージ（右寄せ）
│          │         10:32│  │
│          └───────────────┘  │
│                             │
│  田中さんが入力中...        │  ← ChatTypingIndicator
├─────────────────────────────┤
│  [📎] [メッセージを入力...] [➤] │  ← ChatMessageInput
└─────────────────────────────┘
```

---

## PC 表示: ボトムドロワー

下からスライドして出現するドロワー形式。作業コンテンツの上部は見えたまま、入力欄が画面下部にあるため自然にチャットできる。

### ドロワー閉じた状態

```
┌────────────────────────────────────────────────────────────────────┐
│  [☰] [ロゴ]  [ダッシュボード] [ワークスペース]  [🌙] [💬(3)] [👤]  │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│                     ダッシュボード                                  │
│                     コンテンツ                                      │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

### ドロワー開いた状態（ルーム一覧）

```
┌────────────────────────────────────────────────────────────────────┐
│  [☰] [ロゴ]  [ダッシュボード] [ワークスペース]  [🌙] [💬(3)] [👤]  │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│                     ダッシュボード                                  │
│                     コンテンツ（上部は見える）                      │
│                                                                    │
├────────────────────────────────────────────────────────────────────┤
│  [DM] [グループ] [通知]               チャット             [✕]     │
│  ─────────────────────────────────────────────────────────────    │
│  👤 田中さん (2)      │                                            │
│  👥 開発チーム        │       ルームを選択してください              │
│  🔔 システム (1)      │                                            │
│                       │                                            │
│  [＋ 新規DM]          │                                            │
└────────────────────────────────────────────────────────────────────┘
├─────────────────────────── 高さ: 50% ───────────────────────────┤
```

### ドロワー開いた状態（メッセージ表示）

```
┌────────────────────────────────────────────────────────────────────┐
│  [☰] [ロゴ]  [ダッシュボード] [ワークスペース]  [🌙] [💬(3)] [👤]  │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│                     ダッシュボード                                  │
│                     コンテンツ（上部は見える）                      │
│                                                                    │
├────────────────────────────────────────────────────────────────────┤
│  [DM] [グループ] [通知]               田中さん             [✕]     │
│  ─────────────────────────────────────────────────────────────    │
│  👤 田中さん (2)      │  ┌─────────────────┐                       │
│  👥 開発チーム        │  │ こんにちは！    │                       │
│  🔔 システム (1)      │  └─────────────────┘                       │
│                       │            ┌───────────┐                   │
│  [＋ 新規DM]          │            │ お疲れ様！│                   │
│                       │            └───────────┘                   │
│                       ├────────────────────────────────────────── │
│                       │  [📎] [メッセージを入力...]        [➤]    │
└────────────────────────────────────────────────────────────────────┘
├── ルーム一覧 200px ──┼─────────── メッセージエリア ──────────────┤
```

### ドロワーの挙動

| 操作 | 挙動 |
|------|------|
| 💬 クリック | ドロワーを開く/閉じる（トグル） |
| ✕ ボタン | ドロワーを閉じる |
| Escape キー | ドロワーを閉じる |
| 背景クリック | ドロワーは閉じない（作業継続可能） |

---

## スマホ表示: フル画面遷移

### 遷移フロー

```
ヘッダーの [💬] タップ
        ↓
┌─────────────────────────┐
│  /chat                  │  ルーム一覧（フル画面）
│  [←戻る]  チャット      │
│  [DM] [グループ] [通知]  │
│  ルーム一覧...          │
└─────────────────────────┘
        ↓ ルームをタップ
┌─────────────────────────┐
│  /chat/rooms/{roomId}   │  メッセージ画面（フル画面）
│  [←戻る]  田中さん      │
│  メッセージ一覧...      │
│  [入力欄]               │
└─────────────────────────┘
```

---

## タブ構成

### DM タブ

#### 表示要素

| 表示内容 | 説明 |
|---------|------|
| 1:1 DM ルーム | 相手のアバター + 名前 + 最新メッセージプレビュー |
| 他のメンバー | 最近アクティブなユーザー（既存DMがない人）を5-10件表示 |
| 他のユーザーを探す | ユーザー検索モーダルを開くボタン |

#### 表示順序（ハイブリッド方式）

既存のDMルームと新規DM開始候補を1つのリストで表示する。

```
┌─────────────────────────────────┐
│  [DM] [グループ] [通知]         │
├─────────────────────────────────┤
│  👤 田中さん          約1時間前 │  ← 既存DM（未読あり）
│     お疲れ様です！           2  │
│  👤 佐藤さん          昨日      │  ← 既存DM（未読なし）
│     了解しました               │
├─────────────────────────────────┤
│  ── 他のメンバー ──            │  ← セパレーター
├─────────────────────────────────┤
│  👤 鈴木さん        オンライン   │  ← 最近アクティブ（既存DMなし）
│  👤 山田さん           5分前    │
│  👤 高橋さん          30分前    │
├─────────────────────────────────┤
│  [🔍 他のユーザーを探す]        │  ← 検索モーダル起動
└─────────────────────────────────┘
```

#### 表示ロジック

| セクション | ソート順 | 条件 |
|-----------|---------|------|
| 既存 DM | 1. 未読あり→未読なし<br>2. 最終メッセージ日時降順 | `isDm: true` のルーム |
| 他のメンバー | 最終ログイン日時降順 | 同一組織のアクティブユーザーで既存DMがない人、ログイン履歴ありのみ、5-10件 |

#### ユーザークリック時の挙動

| セクション | クリック時 |
|-----------|-----------|
| 既存 DM | ルームを開いてメッセージ表示 |
| 他のメンバー | DMルームを作成（または取得）してメッセージ画面へ |
| 他のユーザーを探す | ユーザー検索モーダルを表示 |

#### 他のユーザーを探すモーダル

グループタブの新規作成と同様の検索UI。

```
┌───────────────────────────────┐
│ ユーザーを検索         [✕]    │
├───────────────────────────────┤
│ [🔍 名前で検索...]            │
├───────────────────────────────┤
│  👤 渡辺さん      営業部       │
│  👤 伊藤さん      開発部       │
│  👤 小林さん      総務部       │
│  ...                          │
└───────────────────────────────┘
```

### グループタブ

| 表示内容 | 条件 |
|---------|------|
| 組織グループ | `GroupChatScope = Organization` の場合のみ表示 |
| ワークスペースグループ | `GroupChatScope = Workspace` の場合のみ表示 |

### 通知タブ

| 表示内容 | 説明 |
|---------|------|
| システム通知 | 運営からのお知らせ（読み取り専用） |

---

## ヘッダーのチャットアイコン

### 配置

```
navbar-end: [テーマ切替] [💬 チャット] [ユーザーメニュー]
```

### 未読バッジ

- 未読数が 0 より大きい場合、アイコン右上にバッジ表示
- 99 を超える場合は `99+` と表示
- ミュート設定のルームは未読カウントから除外

#### 未読数の表示方針

**フロントエンドは小細工せず、API から取得した件数をそのまま表示する。**

| 方針 | 説明 |
|------|------|
| 表示ロジック | API レスポンスの未読数をそのまま表示 |
| フィルタリング | フロント側で期間フィルタ等は行わない |
| データ整合性 | バックエンドのデータが正（Single Source of Truth） |

> **Note**: メッセージの保持期間はカテゴリによって異なる（例: システム通知は短期、DM は長期）。
> 古いメッセージの削除はバックエンドのバッチジョブで行い、フロントはその結果を素直に表示する。

### クリック時の挙動

| デバイス | 挙動 |
|----------|------|
| スマホ | `/chat` へ遷移（Next.js Router） |
| PC | ボトムドロワーをトグル |

---

## 状態管理

### グローバル状態（Zustand / Context）

```typescript
interface ChatState {
  // ドロワー開閉（PC用）
  isDrawerOpen: boolean;
  toggleDrawer: () => void;

  // 現在選択中のルーム
  selectedRoomId: number | null;
  selectRoom: (roomId: number) => void;

  // 未読数
  unreadCounts: {
    total: number;
    dm: number;
    group: number;
    system: number;
  };

  // アクティブタブ
  activeTab: 'dm' | 'group' | 'system';
  setActiveTab: (tab: 'dm' | 'group' | 'system') => void;
}
```

### SignalR イベント購読（リアルタイム更新）

バックエンドはメッセージ送信時に SignalR で `chat:message_received` イベントを通知する。
フロントエンドはこのイベントを購読し、未読バッジをリアルタイムに更新する。

#### バックエンド → フロントエンドの通知フロー

```
1. ユーザー A がメッセージ送信
2. バックエンド: DB にメッセージ保存
3. バックエンド: SignalR で chat:{roomId} グループに通知
4. フロントエンド: ReceiveNotification イベントを受信
5. フロントエンド: 未読数 API を再取得
6. フロントエンド: Zustand ストアを更新 → バッジが即座に更新
```

#### 実装例

```typescript
// ChatProvider.tsx 内で SignalR イベントを購読
useEffect(() => {
  const handleNotification = (notification: SignalRNotification) => {
    if (notification.eventType === 'chat:message_received') {
      // 未読数を API から再取得してストアを更新
      fetchUnreadCounts();

      // 開いているルームなら新メッセージをリストに追加
      if (notification.payload.roomId === selectedRoomId) {
        addMessage(notification.payload.message);
      }
    }
  };

  signalR.on('ReceiveNotification', handleNotification);
  return () => signalR.off('ReceiveNotification', handleNotification);
}, [selectedRoomId]);
```

#### SignalR イベント一覧

| イベント | タイミング | フロントの処理 | 状態 |
|---------|-----------|---------------|------|
| `chat:message_received` | 新メッセージ受信時 | 未読数再取得、メッセージリスト更新 | ✅ 実装済み |
| `chat:message_read` | 相手が既読にした時 | 既読表示の更新（DM のみ） | ✅ 実装済み |
| `chat:user_typing` | 相手が入力中 | 入力中インジケーター表示 | ✅ 実装済み |

> **Note**: 全イベント実装済み。既読表示は DM（1:1）のみ対応。グループチャットの既読は Phase 4 以降で検討。

---

## レスポンシブ対応

### ブレークポイント

| ブレークポイント | 表示方式 |
|-----------------|---------|
| `< 768px` (md) | フル画面遷移（スマホ） |
| `>= 768px` | ボトムドロワー（PC/タブレット） |

### デバイス判定ロジック

#### 採用方式: CSS Media Query + カスタムフック

**採用理由:**

| 方式 | 全ブラウザ対応 | リアルタイム | 採用 |
|------|---------------|-------------|------|
| CSS Media Query (`window.matchMedia`) | ✅ | ✅ リサイズ対応 | ✅ 採用 |
| User-Agent Client Hints (UA-CH) | ❌ Safari/Firefox 未対応 | - | ❌ 不採用 |
| 従来の User-Agent 解析 | ✅ | ❌ サーバー側のみ | ❌ 不採用 |

> **Note**: UA-CH は Chrome/Edge のみ対応。Safari は実装予定なし、Firefox はプライバシー懸念で消極的。
> スマホ対応最優先のため、iOS Safari で動作しない UA-CH は採用不可。

#### カスタムフック実装

```typescript
// src/hooks/useIsMobile.ts
import { useState, useEffect } from 'react';

const MOBILE_BREAKPOINT = 767; // Tailwind md (768px) の 1px 下

export function useIsMobile(): boolean {
  const [isMobile, setIsMobile] = useState(false);

  useEffect(() => {
    const mediaQuery = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT}px)`);

    // 初期値を設定
    setIsMobile(mediaQuery.matches);

    // リサイズ時の更新
    const handleChange = (e: MediaQueryListEvent) => {
      setIsMobile(e.matches);
    };

    mediaQuery.addEventListener('change', handleChange);
    return () => mediaQuery.removeEventListener('change', handleChange);
  }, []);

  return isMobile;
}
```

#### 使用例

```typescript
// ChatIconButton.tsx
export function ChatIconButton() {
  const isMobile = useIsMobile();
  const router = useRouter();
  const { toggleDrawer } = useChatStore();

  const handleClick = () => {
    if (isMobile) {
      // スマホ: フル画面遷移
      router.push('/chat');
    } else {
      // PC: ボトムドロワーをトグル
      toggleDrawer();
    }
  };

  return (
    <button onClick={handleClick} aria-label="チャット">
      <span className="icon-[tabler--message-circle]" />
      <ChatUnreadBadge />
    </button>
  );
}
```

#### SSR 考慮事項

- `useIsMobile` は `useEffect` 内で判定するため SSR 時は初期値 `false`
- Hydration mismatch を避けるため、デバイス依存の UI は `useEffect` 後に切り替え
- 必要に応じて CSS `hidden md:block` / `block md:hidden` を併用

---

## URL 設計

| パス | 画面 | 備考 |
|------|------|------|
| `/chat` | ルーム一覧 | スマホ: フル画面 / PC: パネル内 |
| `/chat/rooms/[roomId]` | メッセージ画面 | スマホ: フル画面 / PC: パネル内 |
| `/chat/new` | 新規 DM 作成 | ユーザー選択 |

> **Note**: PC でサイドパネルを使う場合、URL は変更せず状態管理で制御。
> スマホは URL ベースの遷移を使用。

---

## アクセシビリティ

| 項目 | 対応 |
|------|------|
| キーボード操作 | Enter で送信、Escape でパネル閉じる |
| スクリーンリーダー | aria-label でルーム名、未読数を読み上げ |
| フォーカス管理 | パネル開閉時に適切な要素にフォーカス |

---

## 実装優先順位

### Phase 1: MVP ✅ 完了

1. ~~ヘッダーにチャットアイコン追加~~
2. ~~ルーム一覧画面（タブ付き）~~
3. ~~メッセージ画面（送受信）~~
4. ~~未読バッジ~~
5. ~~レスポンシブ対応（スマホ: フル画面 / PC: ボトムドロワー）~~

### Phase 2: リアルタイム通知 ✅ 完了

1. ~~SignalR メッセージ受信通知~~
2. ~~リアルタイム未読バッジ更新~~
3. ~~既読位置更新による未読カウント反映~~
4. ~~返信機能~~
5. ~~通知設定（ミュート）~~

### Phase 3: 拡張機能 ✅ 完了

1. ~~入力中インジケーター表示~~ ✅
2. ~~既読表示の更新（相手が読んだことを表示 - DM のみ）~~ ✅
3. ~~DM タブのハイブリッド UI（既存 DM + 他のメンバー + 検索ボタン）~~ ✅

> **Note**: 「アバタークリックで DM 開始」は UserAvatar の使用箇所が多く（59箇所）影響範囲が大きいため、
> 代替としてDMタブ内でのハイブリッド表示方式を採用。詳細は「DM タブ」セクション参照。

### Phase 4: 将来

1. AI アシスタント

---

## 参考

- バックエンド設計: `docs/spec/chat-feature-design.md`
- SignalR 実装: `docs/spec/signalr-implementation.md`

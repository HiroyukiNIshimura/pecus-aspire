# ダッシュボード統計機能 設計書

## 概要

組織内のタスク状況・チーム活動を可視化するダッシュボード統計機能の設計。
Activity テーブル、WorkspaceItem テーブル、WorkspaceTask テーブルを主なデータソースとして、組織レベルの統計情報を提供する。

### WorkspaceItem と WorkspaceTask の違い

| エンティティ | 役割 | 例 |
|------------|------|-----|
| **WorkspaceItem** | コンテンツ（ページ、ドキュメント、情報） | 「ログイン手順」ページ、「API仕様書」 |
| **WorkspaceTask** | 作業単位（やるべきこと） | 「キャプチャ撮影」「説明執筆」「レビュー」 |

**重要**:
- **タスクは必ずアイテムに紐づく**（Workspace → Item → Task の階層構造）
- ワークスペースが「操作マニュアル」の場合、アイテムは「ページ」であり、タスクは「そのページを作る作業」
- 統計機能では**両方を別々に集計**する必要がある

## 設計理念

アクティビティ要件定義の理念を継承:

```
❌ 従来の管理思想
「誰が何時間働いたか」「何回操作したか」を監視

✅ このアプリの考え方
「タスクが進んだか」「成果物が出たか」だけが重要
```

統計は**監視ツールではなく、チームの健康状態を把握するためのもの**。

---

## スコープの柔軟性

すべての統計は**同じデータソース・同じロジック**で、フィルタ条件を変えるだけで以下のスコープに対応可能:

| スコープ | フィルタ条件 | ユースケース |
|---------|-------------|-------------|
| **組織** | `WorkspaceId IN (組織内WS)` | 管理者が全体を把握 |
| **ワークスペース** | `WorkspaceId = @wsId` | プロジェクト単位の状況確認 |
| **個人** | `AssigneeId = @userId` (タスク系) / `UserId = @userId` (アクティビティ系) | 自分の振り返り |

### 個人スコープへのブレイクダウン

| 組織統計 | 個人統計へのフィルタ |
|---------|---------------------|
| 進行中タスク数 | `AssignedUserId = 自分` |
| 完了タスク数 | `AssignedUserId = 自分 && IsCompleted = true` |
| 期限切れタスク数 | `AssignedUserId = 自分 && DueDate < now && !IsCompleted` |
| 優先度別タスク数 | `AssignedUserId = 自分` でグループ |
| 週次作成/完了推移 | Activity `UserId = 自分` |
| アクション別件数 | Activity `UserId = 自分` |

個人統計は設計理念の「本人が振り返るため」に合致。他人のデータは API レベルで閲覧不可とする。

---

## データソース

| エンティティ | 主要フィールド | 用途 |
|-------------|--------------|------|
| **Activity** | `WorkspaceId`, `ItemId`, `UserId`, `ActionType`, `Details`(jsonb), `CreatedAt` | アイテム変更のアクティビティ統計 |
| **WorkspaceItem** | `WorkspaceId`, `IsArchived`, `IsDraft`, `CreatedAt`, `UpdatedAt` | アイテム（コンテンツ）の統計 |
| **WorkspaceTask** | `WorkspaceId`, `WorkspaceItemId`(nullable), `AssignedUserId`, `Priority`, `DueDate`, `IsCompleted`, `IsDiscarded`, `EstimatedHours`, `ProgressPercentage`, `CreatedAt` | タスク（作業）の統計 |
| **WorkspaceUser** | `WorkspaceId`, `UserId`, `WorkspaceRole`, `JoinedAt`, `LastAccessedAt` | ユーザー参加状況 |
| **User** | `OrganizationId`, `IsActive`, `LastLoginAt` | 組織メンバー情報 |

---

## 統計カテゴリ

### 1. タスクサマリ（WorkspaceTask ベース）

リアルタイムでタスクの現在状態を集計。

| 統計項目 | 説明 | クエリ条件 |
|---------|------|-----------|
| **進行中タスク数** | 未完了・未破棄 | `!IsCompleted && !IsDiscarded` |
| **完了タスク数** | 完了済み | `IsCompleted` |
| **破棄タスク数** | 破棄済み | `IsDiscarded` |
| **期限切れタスク数** | 期限超過の未完了タスク | `DueDate < now && !IsCompleted && !IsDiscarded` |
| **今週期限タスク数** | 今週中に期限 | `DueDate BETWEEN now AND endOfWeek && !IsCompleted` |
| **未アサインタスク数** | 担当者未設定 | `AssignedUserId IS NULL && !IsCompleted && !IsDiscarded` |

#### 優先度別タスク数

| 優先度 | 説明 |
|-------|------|
| Low | 低優先度 |
| Medium | 通常 |
| High | 高優先度 |
| Critical | 緊急 |

```sql
-- 例: 優先度別タスク数
SELECT Priority, COUNT(*)
FROM WorkspaceTasks
WHERE WorkspaceId IN (組織内ワークスペース)
  AND NOT IsCompleted AND NOT IsDiscarded
GROUP BY Priority
```

### 2. アイテムサマリ（WorkspaceItem ベース）

コンテンツ（ページ、ドキュメント）の状態を集計。

| 統計項目 | 説明 | クエリ条件 |
|---------|------|-----------|
| **公開アイテム数** | 公開済み・未アーカイブ | `!IsDraft && !IsArchived` |
| **下書きアイテム数** | 下書き状態 | `IsDraft` |
| **アーカイブ済み数** | アーカイブ済み | `IsArchived` |

---

### 2. アクティビティ統計（Activity ベース）

過去のアクションを集計してトレンドを可視化。

| 統計項目 | 説明 | 計算方法 |
|---------|------|---------|
| **タスク作成数** | 期間内に作成されたタスク | `ActionType = Created` |
| **タスク完了数** | 期間内にアーカイブされたタスク | `ActionType = ArchivedChanged && Details.new = true` |
| **アクション別件数** | 各アクションタイプの発生回数 | `GROUP BY ActionType` |
| **日別アクティビティ推移** | 日単位の活動量 | `GROUP BY DATE(CreatedAt)` |
| **時間帯別アクティビティ** | 活発な時間帯（ヒートマップ用） | `GROUP BY HOUR(CreatedAt)` |
| **曜日別アクティビティ** | 曜日ごとの傾向 | `GROUP BY DAYOFWEEK(CreatedAt)` |

#### ActionType 別の意味

| ActionType | 統計的意味 |
|------------|-----------|
| `Created` | アイテム作成量 |
| `ArchivedChanged` (new=true) | アイテム整理量 |
| `SubjectUpdated` / `BodyUpdated` | コンテンツ更新活動 |
| `AssigneeChanged` | アサイン調整頻度 |
| `PriorityChanged` | 優先度見直し頻度 |
| `FileAdded` / `FileRemoved` | 添付ファイル活動 |
| `RelationAdded` / `RelationRemoved` | アイテム関連付け活動 |

---

### 4. ユーザー・チーム統計

| 統計項目 | 説明 | 計算方法 |
|---------|------|----------|
| **担当者別タスク数** | 各ユーザーの保有タスク | WorkspaceTask `GROUP BY AssignedUserId` |
| **担当者別完了数** | 各ユーザーが完了したタスク | WorkspaceTask `IsCompleted = true GROUP BY AssignedUserId` |
| **タスク消化率** | 完了 / (保有 + 完了) | 上記2つの比率 |
| **貢献度** | アクティビティ数 | Activity `COUNT(*) GROUP BY UserId` |
| **平均タスク保有数** | ユーザー平均 | 担当タスク総数 / アクティブユーザー数 |

**注意**: 貢献度は「操作回数」であり、「働いた時間」や「成果の質」ではない。
ランキング表示は推奨しない（監視目的と誤解される可能性）。

---

### 5. 期間比較・トレンド

| 統計項目 | 説明 | 期間例 |
|---------|------|-------|
| **今週 vs 先週** | タスク作成/完了数の比較 | 週次 |
| **今月 vs 先月** | アクティビティ数の比較 | 月次 |
| **週次推移グラフ** | 過去N週間の推移 | 4〜12週 |
| **月次推移グラフ** | 過去N ヶ月の推移 | 6〜12ヶ月 |

#### 計算可能な派生指標

| 指標 | 計算式 | 意味 |
|-----|-------|------|
| **タスク消化率** | 完了数 / 作成数 | 1.0 以上なら消化が追いついている |
| **タスク滞留傾向** | 進行中タスク数の週次変化 | 増加傾向 = 滞留リスク |
| **期限遵守率** | 期限内完了 / 完了総数 | 期限管理の健全性 |

---

### 6. ワークスペース別統計

| 統計項目 | 説明 |
|---------|------|
| **ワークスペース別タスク数** | 各ワークスペースのタスク状況（WorkspaceTask） |
| **ワークスペース別アイテム数** | 各ワークスペースのコンテンツ数（WorkspaceItem） |
| **ワークスペース別アクティビティ** | 活発なワークスペース |
| **ワークスペース別メンバー数** | チーム規模 |

### 7. ホットアイテム・作業集中箇所（Activity ベース）

「どこで作業が活発に行われているか」を可視化し、チームの関心事を把握する。
閲覧数（PV）ではなく、実際に手が動いている「作業の実態」を可視化する方針。

| 統計項目 | 説明 | 計算方法 |
|---------|------|---------|
| **ホットアイテム** | 直近（24h/1週間）でアクティビティが多いアイテム | Activity `GROUP BY ItemId` (直近N日) |
| **タスク集中エリア** | タスクの作成・完了が集中しているワークスペース | Activity `WHERE ActionType IN (TaskAdded, TaskCompleted) GROUP BY WorkspaceId` |

#### ホットアイテム API レスポンス詳細

| フィールド | 型 | 説明 |
|-----------|-----|------|
| `itemId` | int | アイテムID |
| `itemCode` | string | アイテムコード（URL用） |
| `itemSubject` | string | アイテム件名 |
| `workspaceId` | int | ワークスペースID |
| `workspaceCode` | string | ワークスペースコード |
| `workspaceName` | string | ワークスペース名 |
| `genreIcon` | string? | ジャンルアイコン |
| `activityCount` | int | 直近のアクティビティ数 |
| `lastActivityAt` | DateTimeOffset | 最終アクティビティ日時 |
| `lastActorId` | int? | 最終操作者のユーザーID |
| `lastActorName` | string? | 最終操作者の表示名 |
| `lastActorAvatar` | string? | 最終操作者のアバターURL |
| `lastActionLabel` | string? | 最終操作の種類（例: "本文を編集", "ファイル追加"） |
| `canAccess` | bool | 現在のユーザーがこのアイテムにアクセス可能か |

#### UI 表示仕様

- **アクセス可能なアイテム**: リンクとして表示、ホバー時にハイライト
- **アクセス不可のアイテム**: 薄く表示（`opacity-50`）、リンク無効、🔒アイコン表示
- **最終アクター情報**: 「{ユーザー名}が{相対時間}に{操作種類}」形式で表示（例: "田中さんが2分前に本文を編集"）

---

## 現在のデータモデルで取れない統計

| 統計項目 | 理由 | 対応案 |
|---------|------|-------|
| **ステータス別アイテム数** | WorkspaceItem に `Status` カラムがない | 不要 |
| **作業時間** | 開始/終了時刻を記録していない | 設計理念により不要 |
| **コメント数** | コメント機能が Activity に含まれていない | 不要 |
| **タスク完了までの平均時間** | WorkspaceTask の CreatedAt 〜 CompletedAt で計算可能 | 不要 |
| **アイテムごとのタスク進捗** | WorkspaceTask.WorkspaceItemId で紐付け | 集計クエリで対応可能（欲しい） |
| **タスク閲覧数（流入）** | 閲覧ログを保存していない（DB負荷大） | **ホットアイテム統計**で代替（閲覧ではなく操作密度を見る）＝不要 |

---

## ダッシュボード UI 案

### 組織ダッシュボード

```
┌─────────────────────────────────────────────────────────────────┐
│  📊 組織サマリ                                     [今週] [今月] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │ 進行中   │ │ 完了     │ │ 期限切れ │ │ 未アサイン│           │
│  │   234    │ │   95     │ │   12 ⚠️  │ │    8     │           │
│  │ タスク   │ │ (今週)   │ │          │ │          │           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  📈 タスク推移（週次）                                           │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │     ___                                                   │ │
│  │    /   \    作成 ───                                      │ │
│  │   /     \___/   \                                         │ │
│  │  /              \___   完了 - - -                         │ │
│  │ /                   \                                     │ │
│  └───────────────────────────────────────────────────────────┘ │
│    W1    W2    W3    W4    W5    W6    W7    W8               │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  🎯 優先度別タスク                                              │
│  ┌──────────────────────────────────────────────────┐          │
│  │ Critical ████████ 14                             │          │
│  │ High     ████████████████████████ 50             │          │
│  │ Medium   ████████████████████████████████████ 120│          │
│  │ Low      ████████████████████ 50                 │          │
│  └──────────────────────────────────────────────────┘          │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  👥 ワークスペース別状況                                         │
│  ┌─────────────────┬────────┬────────┬────────┐               │
│  │ ワークスペース   │ 進行中 │ 完了   │ 期限切れ│               │
│  ├─────────────────┼────────┼────────┼────────┤               │
│  │ プロジェクトA    │   45   │   23   │   2    │               │
│  │ プロジェクトB    │   32   │   18   │   0    │               │
│  │ プロジェクトC    │   28   │   12   │   5    │               │
│  └─────────────────┴────────┴────────┴────────┘               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 個人ダッシュボード（自分の振り返り用）

```
┌─────────────────────────────────────────────────────────────────┐
│  👤 マイダッシュボード                              [今週] [今月] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                        │
│  │ 担当中   │ │ 完了     │ │ 期限切れ │                        │
│  │   12     │ │    8     │ │    1 ⚠️  │                        │
│  └──────────┘ └──────────┘ └──────────┘                        │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  📝 今週やったこと                                              │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ • タスク完了: 8件（WorkspaceTask）                        │ │
│  │ • アイテム更新: 15件（件名/本文変更など）                  │ │
│  │ • ファイル添付: 5件                                       │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  📅 期限が近いタスク                                            │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ • [PROJ-123] ドキュメント作成        明日 ⚠️               │ │
│  │ • [PROJ-456] レビュー対応            12/15                │ │
│  │ • [PROJ-789] テスト実施              12/18                │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## API エンドポイント

### 実装済み（Phase 1 & 2）

```
GET /api/dashboard/summary
  → 組織サマリ（タスク数、アイテム数など）

GET /api/dashboard/tasks/by-priority
  → 優先度別タスク数

GET /api/dashboard/personal/summary
  → 個人サマリ（担当タスク数、完了数など）

GET /api/dashboard/workspaces
  → ワークスペース別統計

GET /api/dashboard/tasks/trend?weeks=8
  → タスク作成/完了の週次推移（1-12週）

GET /api/dashboard/hot-items?period=24h&limit=10
  → ホットアイテム（直近でアクティビティが多いアイテム）
  - period: "24h"（デフォルト）または "1week"
  - limit: 1-20（デフォルト10）

GET /api/dashboard/hot-workspaces?period=24h&limit=10
  → ホットワークスペース（タスク関連アクティビティが多いワークスペース）
  - period: "24h"（デフォルト）または "1week"
  - limit: 1-20（デフォルト10）
```

### 未実装（Phase 3 以降）

```
GET /api/dashboard/activities/by-type
  ?startDate=2025-12-01&endDate=2025-12-31
  → アクションタイプ別件数
```

---

## パフォーマンス考慮

### キャッシュ戦略（大規模データになってからのfeat）

| 統計種別 | キャッシュ TTL | 理由 |
|---------|--------------|------|
| タスクサマリ | 1分 | リアルタイム性が必要 |
| 週次/月次トレンド | 1時間 | 過去データは変わらない |
| 優先度別・ワークスペース別 | 5分 | 頻繁には変わらない |

### インデックス

統計クエリ用のインデックスを追加済み（マイグレーション: `20251213050503_AddDashboardStatisticsIndexes2`）:

```sql
-- ダッシュボード統計用インデックス（WorkspaceTasks テーブル）
CREATE INDEX IX_WorkspaceTasks_OrganizationId_IsCompleted_IsDiscarded
ON WorkspaceTasks (OrganizationId, IsCompleted, IsDiscarded);

CREATE INDEX IX_WorkspaceTasks_OrganizationId_CreatedAt
ON WorkspaceTasks (OrganizationId, CreatedAt);

CREATE INDEX IX_WorkspaceTasks_OrganizationId_CompletedAt
ON WorkspaceTasks (OrganizationId, CompletedAt);
```

### マテリアライズドビュー案（将来検討）

リアルタイム性が不要な統計は定期更新のマテリアライズドビューで対応:

```sql
-- 日次統計サマリ（毎日深夜に更新）
CREATE MATERIALIZED VIEW daily_statistics AS
SELECT
    DATE(CreatedAt) as date,
    WorkspaceId,
    ActionType,
    COUNT(*) as count
FROM Activities
GROUP BY DATE(CreatedAt), WorkspaceId, ActionType;
```

---

## 実装優先度案

### Phase 1: MVP（必須）

1. 組織サマリ（進行中/完了/期限切れタスク数）
2. 個人サマリ（担当タスク数、今週の完了数）
3. 優先度別タスク数

### Phase 2: トレンド可視化

1. 週次タスク作成/完了推移グラフ
2. ワークスペース別統計
3. ~~期間比較（今週 vs 先週）~~（不要）

### Phase 3: 詳細分析

1. アクションタイプ別統計
2. 時間帯/曜日別ヒートマップ
3. タスク完了までの平均時間

---

## 未決事項

- [ ] ステータス管理の方針決定（WorkspaceItem に Status カラムを追加するか）
- [x] ~~キャッシュ実装方式~~ → 大規模データになってから検討
- [x] ~~統計 API の認可ルール~~ → 全メンバー閲覧可（組織内データのみ）
- [x] ~~グラフ表示ライブラリの選定~~ → **recharts** を採用
- [ ] 統計データのエクスポート機能の要否

---

## 関連ドキュメント

- [ワークスペース・アイテム・タスクの関係](workspace-item-task-relationship.md) - エンティティの基本構造
- [アクティビティ要件定義](activity-requirements.md) - データソースの詳細
- [タスクフォーカス推奨機能](task-focus-recommendation.md) - 同じデータを使った「次にやるべきタスク」推奨機能

---

## 拡張の余地（オンプレ導入時など）

現在の実装は「自分のタスク状況」と「組織全体の統計」のみを提供しているが、オンプレ導入など企業固有の要件に応じて以下の拡張が可能：

| 要望例 | 対応方針 |
|-------|---------|
| 管理者が特定メンバーの状況を確認 | 各APIに `userId` パラメータを追加、管理者権限チェック |
| チームメンバー一覧+各自のタスク数 | `GET /api/dashboard/members` 新規追加 |
| メンバー間の比較・ランキング | 設計理念（監視目的を避ける）と要相談 |

現在のクエリロジック（`DashboardStatisticsService`）に `userId` フィルタを追加するだけで、ほぼ対応可能な設計になっている。

# 認証アーキテクチャ刷新設計書

- 作成日: 2025-12-08
- ステータス: **実装完了** ✅
- 実装日: 2025-12-08

---

## 現状分析（実装前の問題点）

### 旧アーキテクチャ（廃止済み）

```
┌─────────────────────────────────────────────────────────────────┐
│                        クライアント（ブラウザ）                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Cookie に保存（httpOnly: false）                         │   │
│  │  - accessToken   （JWT アクセストークン）                 │   │
│  │  - refreshToken  （リフレッシュトークン）                  │   │
│  │  - user          （ユーザー情報 JSON）                    │   │
│  │  - device        （デバイス情報 JSON）                    │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     Next.js Server                               │
│  ┌──────────────────────┐  ┌──────────────────────────────────┐ │
│  │   middleware.ts      │  │   SessionManager                 │ │
│  │  - Cookie からトークン取得 │  │  - Cookie の読み書き           │ │
│  │  - JWT 有効期限チェック   │  └──────────────────────────────────┘ │
│  │  - 自動リフレッシュ      │                                     │
│  └──────────────────────┘                                     │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      pecus.WebApi                                │
│  ┌──────────────────────┐  ┌──────────────────────────────────┐ │
│  │  RefreshTokenService │  │   Redis (トークンストア)          │ │
│  │  - JWT 発行          │  │  - refresh:{token}              │ │
│  │  - リフレッシュ処理    │  │  - blacklist:{jti}              │ │
│  └──────────────────────┘  └──────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 主な問題点

| 問題 | 詳細 |
|------|------|
| **🔴 Cookie にトークンを直接保存** | `accessToken`, `refreshToken` が Cookie に保存され、ネットカフェ等で端末に情報が残る |
| **🔴 httpOnly: false** | JavaScript からトークンにアクセス可能（XSS 脆弱性リスク） |
| **🟡 トークンが長寿命** | refreshToken は 30 日有効で、盗まれた場合のリスクが高い |
| **🟡 サーバー側セッション管理なし** | ステートレス JWT に依存しており、即時無効化が困難 |

---

## 1. 提案アーキテクチャ

### 「サーバーサイドセッション + Opaque Session ID」方式

```
┌─────────────────────────────────────────────────────────────────┐
│                        クライアント（ブラウザ）                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Cookie に保存（httpOnly: true, secure: true）            │   │
│  │  - sessionId  （opaque session ID のみ）                 │   │
│  │                                                         │   │
│  │  ※ トークンやユーザー情報はブラウザに保存しない             │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     Next.js Server                               │
│  ┌──────────────────────┐  ┌──────────────────────────────────┐ │
│  │   middleware.ts      │  │   ServerSessionManager           │ │
│  │  - sessionId 検証    │  │  - Redis からセッション取得       │ │
│  │  - 有効期限チェック    │  │  - アクセストークンは Redis 内   │ │
│  │  - セッション延長     │  │  - 自動リフレッシュ処理          │ │
│  └──────────────────────┘  └──────────────────────────────────┘ │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │   Redis (Next.js 側)                                      │   │
│  │  - session:{sessionId} → { accessToken, refreshToken,    │   │
│  │                            user, device, expiresAt }     │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      pecus.WebApi（変更なし）                    │
│  ┌──────────────────────┐  ┌──────────────────────────────────┐ │
│  │  RefreshTokenService │  │   Redis (バックエンド側)          │ │
│  │  - JWT 発行          │  │  - refresh:{token}              │ │
│  │  - リフレッシュ処理    │  │  - blacklist:{jti}              │ │
│  └──────────────────────┘  └──────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### この方式のメリット

| メリット | 詳細 |
|----------|------|
| **✅ トークンがブラウザに残らない** | Cookie には opaque な sessionId のみ。トークン漏洩リスク大幅低減 |
| **✅ httpOnly: true** | JavaScript からアクセス不可。XSS 耐性向上 |
| **✅ 即時セッション無効化** | Redis から削除するだけで即座にログアウト可能 |
| **✅ セッション管理の一元化** | Next.js サーバー側で完結、バックエンドへの影響最小 |
| **✅ 既存の Redis 基盤を活用** | 新規インフラ不要 |

---

## 2. 修正が必要なファイル一覧

### フロントエンド（Next.js）

| ファイル | 修正内容 |
|----------|----------|
| `src/libs/session.ts` | **全面書き換え** → `ServerSessionManager` に変更。Redis ベースのセッション管理 |
| `src/libs/redis.ts` | セッション用の操作ヘルパー追加（既存は流用可能） |
| `src/middleware.ts` | Cookie 読み取りを `sessionId` のみに変更、Redis からセッション取得 |
| `src/actions/auth.ts` | ログイン時に Redis セッション作成、Cookie には sessionId のみ設定 |
| `src/connectors/api/auth.ts` | Redis からトークン取得に変更 |
| `src/connectors/api/PecusApiClient.ts` | `getAccessToken` のソースが変わるため軽微な調整 |

### 新規作成

| ファイル | 内容 |
|----------|------|
| `src/libs/serverSession.ts` | Redis ベースのセッションマネージャー（CRUD 操作） |
| `src/libs/sessionTypes.ts` | セッション関連の型定義 |

### バックエンド（pecus.WebApi）

| ファイル | 修正内容 |
|----------|----------|
| **変更なし** | 現在の JWT + Redis リフレッシュトークン方式は維持。Next.js がトークンを管理するだけ |

---

## 3. データ構造設計

### Redis セッションキー

```
session:{sessionId}
```

### セッションデータ（JSON）

```typescript
interface ServerSession {
  // セッション識別子
  sessionId: string;

  // 認証情報（ブラウザには送らない）
  accessToken: string;
  refreshToken: string;
  accessExpiresAt: string;      // ISO 8601
  refreshExpiresAt: string;     // ISO 8601

  // ユーザー情報
  user: {
    id: number;
    name: string;
    email: string;
    roles: string[];
  };

  // デバイス情報
  device: {
    name?: string;
    type?: string;
    os?: string;
    userAgent?: string;
    ipAddress?: string;
  };

  // セッションメタ
  createdAt: string;
  lastAccessedAt: string;
}
```

### TTL 設計

| 項目 | TTL | 理由 |
|------|-----|------|
| セッション | 30 日（スライディング） | リフレッシュトークンと同期 |
| アクティビティ延長 | アクセスごとに TTL リセット | 継続利用時はログアウトさせない |
| 非アクティブ強制ログアウト | 7 日間無操作 | ネットカフェ対策 |

---

## 4. 処理フロー

### ログイン時

```
1. ユーザーがログインフォーム送信
2. Server Action (login) が pecus.WebApi へ認証リクエスト
3. WebApi から accessToken, refreshToken を受領
4. Redis にセッション作成: session:{newSessionId} = {...}
5. Cookie に sessionId のみ設定（httpOnly: true, secure: true, sameSite: strict）
6. ログイン完了
```

### API リクエスト時

```
1. Server Component / Server Action が実行
2. ServerSessionManager.getSession(sessionId) で Redis からセッション取得
3. accessToken の有効期限をチェック
   - 有効 → そのまま API 呼び出し
   - 期限切れ近い → リフレッシュして Redis 更新
4. pecus.WebApi へ accessToken 付きでリクエスト
5. セッションの lastAccessedAt を更新
```

### ログアウト時

```
1. Server Action (logout) 呼び出し
2. Redis からセッション取得、accessToken で WebApi の logout API 呼び出し
3. Redis からセッション削除: DEL session:{sessionId}
4. Cookie 削除
5. ログアウト完了
```

---

## 5. 追加検討事項

### Q1: 同時ログイン制限は必要か？

**→ 不要**（決定済み）

複数デバイスからの同時ログインを許可する。

### Q2: ネットカフェ対策の追加オプション（次フェーズ）

> ⚠️ **次フェーズで検討**

| オプション | 実装難易度 | 効果 |
|------------|------------|------|
| IP 変更検知 | 中 | 異なる IP からのアクセス時に再認証要求 |
| ブラウザフィンガープリント | 高 | デバイス変更検知 |
| 手動「他デバイスログアウト」 | 低 | ユーザー操作で全セッション無効化 |
| セッション一覧表示 | 低 | ユーザーがアクティブセッションを確認・削除 |

### Q3: バックエンドへの委譲候補（次フェーズ）

> ⚠️ **次フェーズで検討**

| 機能 | 推奨 | 理由 |
|------|------|------|
| セッションストア | **フロント（Next.js + Redis）** | Cookie 発行権限がフロントにあるため |
| トークンリフレッシュ | **バックエンド（現状維持）** | 既に実装済み、変更不要 |
| トークン無効化（ブラックリスト） | **バックエンド（現状維持）** | Redis に既に実装済み |
| 全デバイスログアウト | **バックエンド** | ユーザー単位のトークン一括無効化 |

### Q4: Redis 再起動時の影響

**→ 許容（対策は本番デプロイ前に検討）**

Redis が再起動すると、全セッションが消失し全ユーザーが再ログインを強制される。

| 観点 | 評価 |
|------|------|
| **セキュリティ** | ✅ 定期的なセッションクリアはセキュリティ上プラス |
| **ユーザー体験** | ⚠️ 計画メンテナンス時は事前告知で対応可能 |
| **運用** | ⚠️ Redis 障害時に全ユーザー影響は運用リスク |
| **グローバルスタンダード** | ✅ 多くの SaaS がこの方式を採用 |

**本番環境での対策オプション:**

| 対策 | 詳細 |
|------|------|
| Redis 永続化 | `appendonly yes` で AOF 永続化を有効化。再起動後もデータ復元可能 |
| マネージド Redis | Azure Cache for Redis / Amazon ElastiCache でレプリケーション・フェイルオーバー構成 |

開発フェーズでは現状維持とし、本番デプロイ前に Redis 永続化または外部マネージド Redis への移行を計画に含める。

---

## 6. 実装順序

この方針で進める場合、以下の順序で実装を進めます：

1. **`src/libs/serverSession.ts`** - Redis セッションマネージャーの新規実装
2. **`src/libs/session.ts`** - 既存の Cookie ベースから Redis ベースへ移行
3. **`src/middleware.ts`** - sessionId ベースの認証チェックに変更
4. **`src/actions/auth.ts`** - ログイン/ログアウト処理の修正
5. **`src/connectors/api/auth.ts`** - トークン取得ロジックの修正

---

## 7. 関連ファイル参照

### 現行実装

- `pecus.Frontend/src/libs/session.ts` - 現在の Cookie ベースセッション管理
- `pecus.Frontend/src/libs/redis.ts` - Redis クライアント
- `pecus.Frontend/src/middleware.ts` - 認証ミドルウェア
- `pecus.Frontend/src/actions/auth.ts` - 認証アクション
- `pecus.WebApi/Services/RefreshTokenService.cs` - バックエンドのリフレッシュトークン管理

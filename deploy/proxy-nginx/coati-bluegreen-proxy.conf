# Coati - external reverse proxy to deploy-bluegreen nginx
#
# 目的:
# - deploy-bluegreen の nginx は「blue/green 切替」専用で、外部ネットワークから直接アクセスさせない。
# - 別サーバーのプロキシ(Nginx)が、その内部 nginx(HTTP) にだけ到達して中継する。
#
# 使い方（例）:
#   sudo cp deploy-bluegreen/proxy-nginx/coati-bluegreen-proxy.conf /etc/nginx/sites-available/coati
#   sudo ln -sf /etc/nginx/sites-available/coati /etc/nginx/sites-enabled/coati
#   sudo nginx -t && sudo systemctl reload nginx
#
# TODO:
# - server_name / 証明書パス / upstream の host:port を環境に合わせて変更してください。

# =============================================================
# upstream: deploy-bluegreen の nginx（HTTP）
# =============================================================
upstream coati-bluegreen {
    # 例) bluegreen nginx が稼働するホスト/ロードバランサ
    #    - 直接ホスト: 192.168.1.234:80
    #    - ポートを変えている場合: 192.168.1.234:8080
    server 192.168.1.234:80;
    keepalive 32;
}

map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# HTTP → HTTPS redirect
server {
    listen 80;
    server_name coati.bright-l.0am.jp;
    return 301 https://$server_name$request_uri;
}

# TLS termination
server {
    listen 443 ssl;
    http2 on;

    server_name coati.bright-l.0am.jp;
    server_tokens off;

    ssl_certificate     /etc/letsencrypt/live/bright-l.0am.jp/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/bright-l.0am.jp/privkey.pem;

    # cookie の Secure はここで付与
    proxy_cookie_path / "/; HTTPOnly; Secure";

    client_max_body_size 50m;

    proxy_http_version 1.1;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Forwarded-Server $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_buffering on;
    proxy_buffers 256 16k;
    proxy_buffer_size 16k;
    proxy_read_timeout 86400s;

    proxy_hide_header X-Powered-By;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options nosniff;

    access_log  /var/log/nginx/coati-bluegreen.log;
    error_log   /var/log/nginx/coati-bluegreen.error.log;

    # すべて deploy-bluegreen nginx に委譲
    # - /backend/* は内部 nginx が app node の WebApi に転送
    # - /api/* / も内部 nginx が app node の Frontend に転送
    location / {
        # upstream 側が 502 を返した場合も、このサーバー側の error_page を適用したいときに必要
        proxy_intercept_errors on;
        proxy_pass http://coati-bluegreen;
        proxy_redirect http:// https://;
    }

    # Static images (legacy)
    location /images/ {
        alias /var/www/html/images/;
    }

    # Error page (optional)
    error_page 502 /coati-502.html;
    location /coati-502.html {
        root /var/www/html/502;
        internal;
    }
}

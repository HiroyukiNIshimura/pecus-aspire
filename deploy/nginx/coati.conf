# Coati - nginx reverse proxy configuration
# このファイルを /etc/nginx/sites-available/coati にコピーし、
# /etc/nginx/sites-enabled/ にシンボリックリンクを作成してください。
#
# 使用方法:
#   sudo cp deploy/nginx/coati.conf /etc/nginx/sites-available/coati
#   sudo ln -sf /etc/nginx/sites-available/coati /etc/nginx/sites-enabled/coati
#   sudo nginx -t && sudo systemctl reload nginx

upstream coati {
    server 192.168.1.234:3000;
}

upstream coati-api {
    server 192.168.1.234:7265;
}

map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 80;
    server_name coati.bright-l.0am.jp;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    ssl_certificate     /etc/letsencrypt/live/bright-l.0am.jp/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/bright-l.0am.jp/privkey.pem;
    proxy_cookie_path / "/; HTTPOnly; Secure";

    server_name coati.bright-l.0am.jp;
    server_tokens off;

    client_max_body_size 50m;

    proxy_http_version 1.1;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Forwarded-Server $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Frame-Options SAMEORIGIN;
    proxy_buffering on;
    proxy_buffers 256 16k;
    proxy_buffer_size 16k;
    proxy_read_timeout 600s;

    proxy_set_header X-Content-Type-Options nosniff;
    proxy_hide_header X-Powered-By;

    add_header Cache-Control 'private, no-cache, must-revalidate';
    add_header Pragma no-cache;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options nosniff;

    access_log  /var/log/nginx/coati.log;
    error_log   /var/log/nginx/coati.error.log;

    # =================================================================
    # ルーティング設計:
    #   /backend/*  → .NET WebAPI (pecus.WebApi)
    #   /api/*      → Next.js API Routes (pecus.Frontend)
    #   /*          → Next.js フロントエンド
    # =================================================================

    # SignalR Hub via /backend/hubs/ (WebSocket support)
    location /backend/hubs/ {
        proxy_pass http://coati-api/hubs/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400s;
    }

    # .NET WebAPI - すべて /backend/ プレフィックス
    location /backend/ {
        proxy_pass http://coati-api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400s;
    }

    # Next.js API Routes - すべて /api/ プレフィックス
    location /api/ {
        proxy_pass http://coati;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Frontend (Next.js)
    location / {
        proxy_pass http://coati;
        proxy_redirect http:// https://;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # Static images (legacy)
    location /images/ {
        alias /var/www/html/images/;
    }

    # Error pages
    error_page 502 /coati-502.html;
    location /coati-502.html {
        root /var/www/html/502;
        internal;
    }
}

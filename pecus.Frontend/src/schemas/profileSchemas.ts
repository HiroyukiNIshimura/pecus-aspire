import { z } from "zod";

/**
 * ユーザー名（最大50文字）
 */
export const usernameSchema = z
  .string()
  .min(1, "ユーザー名は必須です。")
  .max(50, "ユーザー名は50文字以内で入力してください。");

/**
 * メールアドレス（OpenAPI より最大100文字）
 */
export const newEmailSchema = z
  .email("有効なメールアドレスを入力してください。")
  .max(100, "メールアドレスは100文字以内で入力してください。");

/**
 * 現在のパスワード
 */
export const currentPasswordSchema = z
  .string()
  .min(1, "現在のパスワードは必須です。");

/**
 * 新しいパスワード（WebAPI要件: 大小文字・数字必須）
 * パターン: ^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,}$
 * 要件: 最小8文字、大文字・小文字・数字を必ず含む
 */
export const newPasswordSchema = z
  .string()
  .min(8, "パスワードは8文字以上で入力してください。")
  .max(100, "パスワードは100文字以内で入力してください。")
  .regex(/[a-z]/, "小文字を含める必要があります。")
  .regex(/[A-Z]/, "大文字を含める必要があります。")
  .regex(/\d/, "数字を含める必要があります。");

/**
 * 確認用パスワード
 */
export const confirmPasswordSchema = newPasswordSchema;

/**
 * アバター種別
 */
export const avatarTypeSchema = z.enum([
  "Gravatar",
  "UserAvatar",
  "AutoGenerated",
]);

/**
 * スキル ID リスト
 */
export const skillIdsSchema = z
  .array(z.number().int().positive())
  .optional()
  .nullable();

// ============================================
// フォーム別スキーマ
// ============================================

/**
 * メール変更フォーム（トークンベース認証）
 */
export const updateEmailFormSchema = z.object({
  newEmail: newEmailSchema,
  currentPassword: currentPasswordSchema,
});
export type UpdateEmailFormInput = z.infer<typeof updateEmailFormSchema>;

/**
 * パスワード変更フォーム
 */
export const updatePasswordFormSchema = z
  .object({
    currentPassword: currentPasswordSchema,
    newPassword: newPasswordSchema,
    confirmPassword: confirmPasswordSchema,
  })
  .refine((data) => data.newPassword === data.confirmPassword, {
    message: "新しいパスワードが一致しません。",
    path: ["confirmPassword"],
  })
  .refine((data) => data.currentPassword !== data.newPassword, {
    message: "新しいパスワードは現在のパスワードと異なる必要があります。",
    path: ["newPassword"],
  });
export type UpdatePasswordFormInput = z.infer<typeof updatePasswordFormSchema>;

/**
 * プロフィール更新フォーム（ユーザー名、アバター）
 */
export const updateProfileFormSchema = z.object({
  username: usernameSchema.optional(),
  avatarType: avatarTypeSchema.optional(),
});
export type UpdateProfileFormInput = z.infer<typeof updateProfileFormSchema>;

/**
 * スキル設定フォーム
 */
export const updateSkillsFormSchema = z.object({
  skillIds: skillIdsSchema,
});
export type UpdateSkillsFormInput = z.infer<typeof updateSkillsFormSchema>;

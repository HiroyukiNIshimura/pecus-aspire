import { z } from 'zod';

/**
 * ユーザー名（最大50文字）
 */
export const usernameSchema = z
  .string()
  .min(1, 'ユーザー名は必須です。')
  .max(50, 'ユーザー名は50文字以内で入力してください。');

/**
 * メールアドレス（OpenAPI より最大100文字）
 */
export const newEmailSchema = z
  .email('有効なメールアドレスを入力してください。')
  .max(100, 'メールアドレスは100文字以内で入力してください。');

/**
 * 現在のパスワード
 */
export const currentPasswordSchema = z.string().min(1, '現在のパスワードは必須です。');

/**
 * 新しいパスワード（WebAPI要件: 大小文字・数字必須）
 * 要件: 最小8文字、大文字・小文字・数字を必ず含む
 */
export const newPasswordSchema = z
  .string()
  .min(8, 'パスワードは8文字以上で入力してください。')
  .max(100, 'パスワードは100文字以内で入力してください。')
  .regex(/[a-z]/, '小文字を含める必要があります。')
  .regex(/[A-Z]/, '大文字を含める必要があります。')
  .regex(/\d/, '数字を含める必要があります。');

/**
 * 確認用パスワード
 */
export const confirmPasswordSchema = newPasswordSchema;

/**
 * アバター種別
 */
export const avatarTypeSchema = z.enum(['Gravatar', 'UserAvatar', 'AutoGenerated']);

/**
 * スキル ID リスト
 */
export const skillIdsSchema = z.array(z.number().int().positive()).optional().nullable();

// ============================================
// フォーム別スキーマ
// ============================================

/**
 * メール変更フォーム（トークンベース認証）
 */
export const updateEmailFormSchema = z.object({
  newEmail: newEmailSchema,
  currentPassword: currentPasswordSchema,
});
export type UpdateEmailFormInput = z.infer<typeof updateEmailFormSchema>;

/**
 * パスワード変更フォーム
 */
export const updatePasswordFormSchema = z
  .object({
    currentPassword: currentPasswordSchema,
    newPassword: newPasswordSchema,
    confirmPassword: confirmPasswordSchema,
  })
  .refine((data) => data.newPassword === data.confirmPassword, {
    message: '新しいパスワードが一致しません。',
    path: ['confirmPassword'],
  })
  .refine((data) => data.currentPassword !== data.newPassword, {
    message: '新しいパスワードは現在のパスワードと異なる必要があります。',
    path: ['newPassword'],
  });
export type UpdatePasswordFormInput = z.infer<typeof updatePasswordFormSchema>;

/**
 * プロフィール更新フォーム（ユーザー名、アバター）
 */
export const updateProfileFormSchema = z.object({
  username: usernameSchema.optional(),
  avatarType: avatarTypeSchema.optional(),
});
export type UpdateProfileFormInput = z.infer<typeof updateProfileFormSchema>;

/**
 * スキル設定フォーム
 */
export const updateSkillsFormSchema = z.object({
  skillIds: skillIdsSchema,
});
export type UpdateSkillsFormInput = z.infer<typeof updateSkillsFormSchema>;

/**
 * ユーザー作成フォーム（管理者用・パスワードなし）
 * Note: roles は配列のためフォームバリデーションでは扱わず、コンポーネント側で別途バリデーションする
 * Note: displayName はブラウザのサインイン自動入力を回避するための名称（内部的には username）
 */
export const createUserWithoutPasswordSchema = z.object({
  displayName: usernameSchema,
  email: newEmailSchema,
});
export type CreateUserWithoutPasswordInput = z.infer<typeof createUserWithoutPasswordSchema>;

/**
 * スキル名（最大100文字）
 */
export const skillNameSchema = z
  .string()
  .min(1, 'スキル名は必須です。')
  .max(100, 'スキル名は100文字以内で入力してください。');

/**
 * スキル説明（最大500文字、オプション）
 */
export const skillDescriptionSchema = z
  .string()
  .max(500, '説明は500文字以内で入力してください。')
  .optional()
  .or(z.literal(''));

/**
 * スキル作成フォーム（管理者用）
 */
export const createSkillSchema = z.object({
  name: skillNameSchema,
  description: skillDescriptionSchema,
});
export type CreateSkillInput = z.infer<typeof createSkillSchema>;

/**
 * タグ名（最大50文字）
 */
export const tagNameSchema = z.string().min(1, 'タグ名は必須です。').max(50, 'タグ名は50文字以内で入力してください。');

/**
 * タグ作成フォーム（管理者用）
 */
export const createTagSchema = z.object({
  name: tagNameSchema,
});
export type CreateTagInput = z.infer<typeof createTagSchema>;

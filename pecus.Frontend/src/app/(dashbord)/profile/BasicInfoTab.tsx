"use client";

import { useState } from "react";
import type { UserResponse } from "@/connectors/api/pecus";
import { updateProfile, uploadAvatarFile } from "@/actions/profile";

interface BasicInfoTabProps {
  user: UserResponse;
  onUpdate: (updatedUser: UserResponse) => void;
  onAlert: (type: "success" | "error" | "info", message: string) => void;
  isLoading: boolean;
  setIsLoading: (loading: boolean) => void;
}

export default function BasicInfoTab({
  user,
  onUpdate,
  onAlert,
  isLoading,
  setIsLoading,
}: BasicInfoTabProps) {
  const [username, setUsername] = useState<string>(user.username || "");
  const [selectedAvatarType, setSelectedAvatarType] = useState<
    "Gravatar" | "UserAvatar" | "AutoGenerated"
  >(user.avatarType || "Gravatar");
  const [uploadedFileUrl, setUploadedFileUrl] = useState<string | null>(null);
  const [avatarPreviewUrl, setAvatarPreviewUrl] = useState<string | null>(null);

  const handleFileUpload = async (
    event: React.ChangeEvent<HTMLInputElement>
  ) => {
    const file = event.target.files?.[0];
    if (!file) return;

    // プレビュー表示
    const reader = new FileReader();
    reader.onload = (e) => {
      setAvatarPreviewUrl(e.target?.result as string);
    };
    reader.readAsDataURL(file);

    // ファイルアップロード
    setIsLoading(true);
    try {
      const formData = new FormData();
      formData.append("file", file);
      const uploadResult = await uploadAvatarFile(formData);
      if (uploadResult.success) {
        setUploadedFileUrl(uploadResult.data?.fileUrl || null);
      } else {
        onAlert("error", uploadResult.message || "アップロードに失敗しました");
      }
    } finally {
      setIsLoading(false);
    }
  };

  const handleBasicInfoSubmit = async () => {
    setIsLoading(true);
    try {
      const result = await updateProfile({
        username: username !== user.username ? username : undefined,
        avatarType: selectedAvatarType,
        avatarUrl: uploadedFileUrl || undefined,
        rowVersion: user.rowVersion,
      });

      if (result.success) {
        onUpdate(result.data);
        setUploadedFileUrl(null);
        setAvatarPreviewUrl(null);
        onAlert("success", "基本情報が更新されました");
      } else {
        onAlert("error", result.message || "更新に失敗しました");
      }
    } catch (error) {
      console.error("Profile update error:", error);
      onAlert("error", "予期しないエラーが発生しました");
    } finally {
      setIsLoading(false);
    }
  };

  const handleFileReset = () => {
    setUploadedFileUrl(null);
    setAvatarPreviewUrl(null);
  };

  return (
    <div className="space-y-6 bg-base-100">
      <div className="form-control">
        <label htmlFor="username" className="label">
          <span className="label-text font-semibold text-base-content">ユーザー名</span>
        </label>
        <input
          id="username"
          type="text"
          placeholder="ユーザー名を入力"
          className="input input-bordered"
          value={username}
          onChange={(e) => setUsername(e.target.value)}
          disabled={isLoading}
        />
      </div>

      <div className="form-control">
        <label htmlFor="avatarType" className="label">
          <span className="label-text font-semibold text-base-content">アバタータイプ</span>
        </label>
        <select
          id="avatarType"
          className="select select-bordered"
          value={selectedAvatarType}
          onChange={(e) =>
            setSelectedAvatarType(
              e.target.value as "Gravatar" | "UserAvatar" | "AutoGenerated"
            )
          }
          disabled={isLoading}
        >
          <option value="Gravatar">Gravatar（メールアドレス連動）</option>
          <option value="UserAvatar">カスタム画像</option>
          <option value="AutoGenerated">自動生成</option>
        </select>
        <label className="label">
          <span className="label-text-alt text-base-content/60">
            {selectedAvatarType === "Gravatar" && "メールアドレスに紐づいた Gravatar アバターを使用します"}
            {selectedAvatarType === "UserAvatar" && "独自の画像をアップロードして使用します"}
            {selectedAvatarType === "AutoGenerated" && "システムが自動生成したアバターを使用します"}
          </span>
        </label>
      </div>

      {selectedAvatarType === "UserAvatar" && (
        <div className="form-control">
          <label htmlFor="avatarFile" className="label">
            <span className="label-text font-semibold text-base-content">アバター画像</span>
          </label>
          <input
            id="avatarFile"
            type="file"
            accept="image/*"
            className="file-input file-input-bordered"
            onChange={handleFileUpload}
            disabled={isLoading}
          />
          {avatarPreviewUrl && (
            <div className="mt-4 flex items-center gap-4">
              <div>
                <img
                  src={avatarPreviewUrl}
                  alt="プレビュー"
                  className="w-24 h-24 rounded-lg object-cover"
                />
              </div>
              <button
                type="button"
                onClick={handleFileReset}
                className="btn btn-sm btn-outline"
                disabled={isLoading}
              >
                リセット
              </button>
            </div>
          )}
        </div>
      )}

      <div className="flex justify-end mt-6">
        <button
          type="button"
          onClick={handleBasicInfoSubmit}
          className="btn btn-primary"
          disabled={isLoading}
        >
          {isLoading ? (
            <>
              <span className="loading loading-spinner loading-sm"></span>
              更新中...
            </>
          ) : (
            "基本情報を更新"
          )}
        </button>
      </div>
    </div>
  );
}

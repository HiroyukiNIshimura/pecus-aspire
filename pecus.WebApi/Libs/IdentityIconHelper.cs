using Pecus.Libs.DB.Models.Enums;
using System.Security.Cryptography;
using System.Text;

namespace Pecus.Libs;

/// <summary>
/// ユーザーのアイデンティティアイコンを取得するヘルパー
/// </summary>
public static class IdentityIconHelper
{
    /// <summary>
    /// アイデンティティアイコンのタイプ
    /// </summary>
    public enum IconType
    {
        /// <summary>
        /// Gravatarを使用
        /// </summary>
        Gravatar,

        /// <summary>
        /// ユーザーがアップロードしたアイコン
        /// </summary>
        UserAvatar,

        /// <summary>
        /// 自動生成されたアイデンティティアイコン
        /// </summary>
        AutoGenerated,
    }

    /// <summary>
    /// GravatarのURLを生成
    /// </summary>
    /// <param name="email">メールアドレス</param>
    /// <param name="size">画像サイズ（ピクセル）</param>
    /// /// <returns>GravatarのURL</returns>
    public static string GetGravatarUrl(string email, int size = 64)
    {
        if (string.IsNullOrWhiteSpace(email))
        {
            return string.Empty;
        }

        // メールアドレスを小文字に変換してMD5ハッシュを生成
        var emailHash = GetMd5Hash(email.Trim().ToLowerInvariant());

        return $"https://www.gravatar.com/avatar/{emailHash}?s={size}";
    }

    /// <summary>
    /// ユーザーアップロードアイコンのURLを取得（Base64 DataURL形式）
    /// </summary>
    /// <remarks>
    /// <para>
    /// avatarPath は以下の形式に対応しています：
    /// </para>
    /// <list type="bullet">
    /// <item><description>ファイル名のみ: "filename.png"</description></item>
    /// <item><description>API パス: "/api/downloads/avatar/3/filename.png"</description></item>
    /// <item><description>相対パス: "avatar/3/filename.png"</description></item>
    /// </list>
    /// <para>
    /// いずれの形式でも、ファイル名部分を抽出して物理ファイルパスを構築します。
    /// </para>
    /// </remarks>
    /// <param name="organizationId">組織ID</param>
    /// <param name="userId">ユーザーID</param>
    /// <param name="avatarPath">アバターパス（ファイル名 or API パス or 相対パス）</param>
    /// <param name="uploadsPath">アップロードファイルのルートパス（デフォルト: "uploads"）</param>
    /// <returns>Base64 DataURL形式のアイコンURL（例: "data:image/png;base64,..."）、失敗時は空文字列</returns>
    public static string GetUserAvatarUrl(
        int? organizationId,
        int userId,
        string? avatarPath,
        string uploadsPath = "uploads"
    )
    {
        // 入力検証
        if (string.IsNullOrWhiteSpace(avatarPath) || !organizationId.HasValue)
        {
            return string.Empty;
        }

        try
        {
            // ステップ1: avatarPath からファイル名を抽出
            // "/api/downloads/avatar/3/file.png" → "file.png"
            // "file.png" → "file.png"
            var fileName = ExtractFileName(avatarPath);

            // ステップ2: 物理ファイルパスを構築
            // uploads/{organizationId}/avatar/{userId}/{fileName}
            var physicalFilePath = BuildAvatarFilePath(
                uploadsPath: uploadsPath,
                organizationId: organizationId.Value,
                userId: userId,
                fileName: fileName
            );

            // ステップ3: ファイル存在チェック
            if (!File.Exists(physicalFilePath))
            {
                return string.Empty;
            }

            // ステップ4: ファイルを読み込んでBase64エンコード
            var fileBytes = File.ReadAllBytes(physicalFilePath);
            var base64String = Convert.ToBase64String(fileBytes);

            // ステップ5: MIME タイプを推定
            var mimeType = GetMimeTypeFromExtension(fileName);

            // ステップ6: DataURL形式で返却
            return $"data:{mimeType};base64,{base64String}";
        }
        catch
        {
            // ファイル読み込み失敗時は空文字列を返す
            // （権限エラー、I/Oエラー等）
            return string.Empty;
        }
    }

    /// <summary>
    /// パス文字列からファイル名を抽出
    /// </summary>
    /// <param name="path">ファイルパスまたはファイル名</param>
    /// <returns>ファイル名部分</returns>
    private static string ExtractFileName(string path)
    {
        // パス区切り文字が含まれている場合はファイル名のみを抽出
        // 例: "/api/downloads/avatar/3/file.png" → "file.png"
        //     "file.png" → "file.png"
        return path.Contains('/') || path.Contains('\\')
            ? Path.GetFileName(path)
            : path;
    }

    /// <summary>
    /// アバターファイルの物理パスを構築
    /// </summary>
    /// <param name="uploadsPath">アップロードルートパス</param>
    /// <param name="organizationId">組織ID</param>
    /// <param name="userId">ユーザーID</param>
    /// <param name="fileName">ファイル名</param>
    /// <returns>物理ファイルパス</returns>
    private static string BuildAvatarFilePath(
        string uploadsPath,
        int organizationId,
        int userId,
        string fileName
    )
    {
        // 標準的なアバターファイル配置パターン
        // {uploadsPath}/{organizationId}/avatar/{userId}/{fileName}
        return Path.Combine(
            uploadsPath,
            organizationId.ToString(),
            "avatar",
            userId.ToString(),
            fileName
        );
    }

    /// <summary>
    /// ファイル拡張子からMIMEタイプを推定
    /// </summary>
    /// <param name="fileName">ファイル名</param>
    /// <returns>MIMEタイプ（例: "image/png"）</returns>
    private static string GetMimeTypeFromExtension(string fileName)
    {
        var extension = Path.GetExtension(fileName).ToLowerInvariant();
        return extension switch
        {
            ".png" => "image/png",
            ".jpg" or ".jpeg" => "image/jpeg",
            ".gif" => "image/gif",
            ".webp" => "image/webp",
            ".svg" => "image/svg+xml",
            ".bmp" => "image/bmp",
            ".ico" => "image/x-icon",
            _ => "image/jpeg" // デフォルトはJPEG
        };
    }

    /// <summary>
    /// 自動生成されたアイデンティティアイコンのURLを取得
    /// </summary>
    /// <param name="userId">ユーザーID</param>
    /// <param name="username">ユーザー名</param>
    /// <param name="size">画像サイズ（ピクセル）</param>
    /// <returns>自動生成アイコンのURL</returns>
    public static string GetAutoGeneratedIconUrl(int userId, string username, int size = 200)
    {
        // TODO: 実際の自動生成アイコンサービスに応じて実装を調整
        // オプション:
        // 1. DiceBear API: https://dicebear.com/
        // 2. UI Avatars: https://ui-avatars.com/
        // 3. BoringAvatars: https://boringavatars.com/
        // 4. 独自実装のアイコン生成サービス

        // スタブ実装: UI Avatarsを使用
        var encodedName = Uri.EscapeDataString(username);
        return $"https://ui-avatars.com/api/?name={encodedName}&size={size}&rounded=true";
    }

    /// <summary>
    /// ユーザーのアイデンティティアイコンURLを取得
    /// </summary>
    /// <param name="iconType">アイコンタイプ</param>
    /// <param name="organizationId">組織ID（UserAvatarの場合必須）</param>
    /// <param name="userId">ユーザーID</param>
    /// <param name="username">ユーザー名</param>
    /// <param name="email">メールアドレス</param>
    /// <param name="avatarPath">アバターパス（UserAvatarの場合）</param>
    /// <param name="uploadsPath">アップロードファイルのルートパス（デフォルト: "uploads"）</param>
    /// <param name="size">画像サイズ</param>
    /// <returns>アイコンのURL（必ず有効な文字列を返す）</returns>
    public static string GetIdentityIconUrl(
        AvatarType? iconType,
        int? organizationId,
        int userId,
        string username,
        string email,
        string? avatarPath = null,
        string uploadsPath = "uploads",
        int size = 200
    )
    {
        return iconType switch
        {
            AvatarType.Gravatar => GetGravatarUrl(email, size),
            AvatarType.UserAvatar => GetUserAvatarUrlOrFallback(
                organizationId: organizationId,
                userId: userId,
                username: username,
                avatarPath: avatarPath,
                uploadsPath: uploadsPath,
                size: size
            ),
            AvatarType.AutoGenerated => GetAutoGeneratedIconUrl(userId, username, size),
            _ => GetAutoGeneratedIconUrl(userId, username, size), // デフォルトは自動生成
        };
    }

    /// <summary>
    /// UserAvatar取得を試み、失敗時はAutoGeneratedにフォールバック
    /// </summary>
    private static string GetUserAvatarUrlOrFallback(
        int? organizationId,
        int userId,
        string username,
        string? avatarPath,
        string uploadsPath,
        int size
    )
    {
        var userAvatarUrl = GetUserAvatarUrl(
            organizationId: organizationId,
            userId: userId,
            avatarPath: avatarPath,
            uploadsPath: uploadsPath
        );

        // UserAvatarが取得できなかった場合（空文字列）はAutoGeneratedにフォールバック
        return string.IsNullOrEmpty(userAvatarUrl)
            ? GetAutoGeneratedIconUrl(userId, username, size)
            : userAvatarUrl;
    }

    /// <summary>
    /// MD5ハッシュを生成
    /// </summary>
    private static string GetMd5Hash(string input)
    {
        using var md5 = MD5.Create();
        var inputBytes = Encoding.UTF8.GetBytes(input);
        var hashBytes = md5.ComputeHash(inputBytes);

        return Convert.ToHexString(hashBytes).ToLowerInvariant();
    }

    /// <summary>
    /// デフォルトのアイコンタイプを取得
    /// </summary>
    /// <returns>デフォルトのアイコンタイプ</returns>
    public static string GetDefaultIconType() => "auto-generated";

}